-- [[ LOCAL SCRIPT: FlyClient (Fixed & Clean) ]]
-- FEATURES: Auto-Cleanup, Smooth Banking, Robust No-Clip
-- FIX: Deleting this script now correctly removes flight physics.

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera
local character = player.Character or player.CharacterAdded:Wait()
local rootPart = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")

-- ‚öôÔ∏è SETTINGS
local SPEED_NORMAL = 100
local SPEED_BOOST = 150
local SMOOTHNESS = 0.2
local BANK_ANGLE = 15

-- üõ†Ô∏è STATE
local isFlying = true
local currentSpeed = SPEED_NORMAL
local noclipConnection = nil 
local runtimeFolder = nil -- Holds our physics objects

-- üîó PHYSICS SETUP
-- We create a folder so we can destroy EVERYTHING in one go
runtimeFolder = Instance.new("Folder")
runtimeFolder.Name = "FlyRuntime"
runtimeFolder.Parent = rootPart

local attachment = Instance.new("Attachment", runtimeFolder)

local alignPos = Instance.new("LinearVelocity")
alignPos.Attachment0 = attachment
alignPos.MaxForce = math.huge
alignPos.VectorVelocity = Vector3.zero
alignPos.VelocityConstraintMode = Enum.VelocityConstraintMode.Vector
alignPos.Parent = runtimeFolder

local alignRot = Instance.new("AlignOrientation")
alignRot.Attachment0 = attachment
alignRot.Mode = Enum.OrientationAlignmentMode.OneAttachment
alignRot.RigidityEnabled = false 
alignRot.Responsiveness = 20
alignRot.Parent = runtimeFolder

-- üö´ ANIMATION & NO-CLIP
humanoid.PlatformStand = true

noclipConnection = RunService.Stepped:Connect(function()
	if not character then return end
	for _, part in pairs(character:GetDescendants()) do
		if part:IsA("BasePart") and part.CanCollide == true then
			part.CanCollide = false
		end
	end
end)

-- üõë STOP FUNCTION (The Fix)
function stopFlying()
	if not isFlying then return end
	isFlying = false

	-- 1. Disconnect Loop immediately
	if noclipConnection then 
		noclipConnection:Disconnect() 
		noclipConnection = nil
	end

	-- 2. Destroy Physics Folder (Cleans Attachment, Velocity, Orientation at once)
	if runtimeFolder then 
		runtimeFolder:Destroy() 
		runtimeFolder = nil
	end

	-- 3. Restore Character
	if humanoid and humanoid.Parent then
		humanoid.PlatformStand = false
	end
	
	-- 4. Restore Collision Safety
	if character then
		for _, part in pairs(character:GetDescendants()) do
			if part:IsA("BasePart") then
				part.CanCollide = true
			end
		end
	end

	-- 5. Self-Destruct if not already destroyed
	if script and script.Parent then
		script:Destroy()
	end
end

-- üîÅ UPDATE LOOP
local function update(dt)
	if not isFlying or not rootPart.Parent then return end

	local controlModule = require(player.PlayerScripts:WaitForChild("PlayerModule")):GetControls()
	local inputMove = controlModule:GetMoveVector()

	local yAxis = 0
	if UserInputService:IsKeyDown(Enum.KeyCode.Space) then yAxis = 1 end
	if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then yAxis = -1 end

	currentSpeed = UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) and SPEED_BOOST or SPEED_NORMAL

	local camCFrame = camera.CFrame
	local moveDir = (camCFrame.RightVector * inputMove.X) + (camCFrame.LookVector * -inputMove.Z)
	local targetVelocity = (moveDir * currentSpeed) + Vector3.new(0, yAxis * currentSpeed, 0)

	if alignPos and alignPos.Parent then
		alignPos.VectorVelocity = alignPos.VectorVelocity:Lerp(targetVelocity, SMOOTHNESS)
	end

	if alignRot and alignRot.Parent then
		local tiltZ = -inputMove.X * BANK_ANGLE
		local targetCFrame = camCFrame * CFrame.Angles(0, 0, math.rad(tiltZ))
		alignRot.CFrame = targetCFrame
	end
end

-- üëÇ LISTENERS FOR CLEANUP
-- Case A: Server deletes script
script.AncestryChanged:Connect(function()
	if not script.Parent then stopFlying() end
end)

-- Case B: Server sets attribute
character:GetAttributeChangedSignal("ForceStopFly"):Connect(function()
	if character:GetAttribute("ForceStopFly") then stopFlying() end
end)

-- Case C: User presses X
UserInputService.InputBegan:Connect(function(input, processed)
	if processed then return end
	if input.KeyCode == Enum.KeyCode.X then stopFlying() end
end)

RunService.RenderStepped:Connect(update)
