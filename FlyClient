-- [[ LOCAL SCRIPT: FlyClient (No GUI Version) ]]
-- FEATURES: Smooth Banking, Modern Physics, ROBUST NO-CLIP.
-- CONTROLS: WASD: Move | SPACE: Up | CTRL: Down | SHIFT: Speed Boost | X: Stop

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera
local character = player.Character or player.CharacterAdded:Wait()
local rootPart = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")

-- ‚öôÔ∏è SETTINGS
local SPEED_NORMAL = 100
local SPEED_BOOST = 150
local SMOOTHNESS = 0.2 -- Lower is smoother (0.1 - 0.5)
local BANK_ANGLE = 15 -- How much to tilt when turning

-- üõ†Ô∏è STATE
local isFlying = true
local currentSpeed = SPEED_NORMAL
local noclipConnection = nil 

-- üîó PHYSICS SETUP (Modern Constraints)
local attachment = Instance.new("Attachment", rootPart)

local alignPos = Instance.new("LinearVelocity")
alignPos.Attachment0 = attachment
alignPos.MaxForce = math.huge
alignPos.VectorVelocity = Vector3.zero
alignPos.VelocityConstraintMode = Enum.VelocityConstraintMode.Vector
alignPos.Parent = rootPart

local alignRot = Instance.new("AlignOrientation")
alignRot.Attachment0 = attachment
alignRot.Mode = Enum.OrientationAlignmentMode.OneAttachment
alignRot.RigidityEnabled = false -- Smooth rotation
alignRot.Responsiveness = 20
alignRot.Parent = rootPart

-- üö´ ANIMATION & ROBUST NO-CLIP
humanoid.PlatformStand = true

-- We use 'Stepped' to force CanCollide to false EVERY PHYSICS FRAME.
noclipConnection = RunService.Stepped:Connect(function()
	if not character then return end
	for _, part in pairs(character:GetDescendants()) do
		if part:IsA("BasePart") and part.CanCollide == true then
			part.CanCollide = false
		end
	end
end)

-- üõë STOP FUNCTION
function stopFlying()
	if not isFlying then return end
	isFlying = false

	-- Cleanup Physics
	if alignPos then alignPos:Destroy() end
	if alignRot then alignRot:Destroy() end
	if attachment then attachment:Destroy() end

	-- Stop Noclip Loop
	if noclipConnection then noclipConnection:Disconnect() end

	-- Restore Character
	humanoid.PlatformStand = false

	-- Restore Collision (Safety check so you don't fall through floor)
	for _, part in pairs(character:GetDescendants()) do
		if part:IsA("BasePart") then
			part.CanCollide = true
		end
	end

	-- Kill Script
	script:Destroy()
end

-- üîÅ UPDATE LOOP
local function update(dt)
	if not isFlying or not character.Parent or not rootPart.Parent then return end

	-- 1. INPUT HANDLING
	local controlModule = require(player.PlayerScripts:WaitForChild("PlayerModule")):GetControls()
	local inputMove = controlModule:GetMoveVector()

	-- Vertical Logic (PC/Keyboard)
	local yAxis = 0
	if UserInputService:IsKeyDown(Enum.KeyCode.Space) then yAxis = 1 end
	if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then yAxis = -1 end

	-- Speed Boost (Shift)
	currentSpeed = UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) and SPEED_BOOST or SPEED_NORMAL

	-- 2. CALCULATE VELOCITY
	local camCFrame = camera.CFrame
	-- Calculate direction relative to camera
	local moveDir = (camCFrame.RightVector * inputMove.X) + (camCFrame.LookVector * -inputMove.Z)
	local targetVelocity = (moveDir * currentSpeed) + Vector3.new(0, yAxis * currentSpeed, 0)

	-- 3. APPLY PHYSICS
	alignPos.VectorVelocity = alignPos.VectorVelocity:Lerp(targetVelocity, SMOOTHNESS)

	-- 4. ORIENTATION (Banking effect)
	local tiltZ = -inputMove.X * BANK_ANGLE
	local targetCFrame = camCFrame * CFrame.Angles(0, 0, math.rad(tiltZ))
	alignRot.CFrame = targetCFrame
end

-- INPUT LISTENER (Toggle/Stop)
UserInputService.InputBegan:Connect(function(input, processed)
	if processed then return end
	if input.KeyCode == Enum.KeyCode.X then
		stopFlying()
	end
end)

RunService.RenderStepped:Connect(update)
