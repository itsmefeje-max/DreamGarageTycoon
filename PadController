-- ( SERVER SCRIPT: PadController - FIXED PICKUP )
-- Refactored to specifically look in 'CarTools' for reliable item retrieval.

local ServerStorage = game:GetService("ServerStorage")
local Workspace = game:GetService("Workspace")
local StarterPack = game:GetService("StarterPack")
local Debris = game:GetService("Debris")

-- === ‚öôÔ∏è TUNING ===
local VERTICAL_OFFSET = -1
local PROMPT_RANGE = 14  
-- =================

-- üìÇ FOLDER REFERENCES
-- We specifically reference CarTools so we can find the items reliably.
local CarModels = ServerStorage:WaitForChild("CarModels")
local CarTools = ServerStorage:WaitForChild("CarTools") -- ‚úÖ Added this line
local TycoonFolder = Workspace:WaitForChild("Tycoons") 

local function getPlotFolder(obj)
	local current = obj
	while current and current.Parent do
		if current.Parent == TycoonFolder then
			return current
		end
		current = current.Parent
	end
	return nil
end

local function getMainPart(obj)
	if obj:IsA("BasePart") then return obj end
	if obj:IsA("Model") then
		if obj.PrimaryPart then return obj.PrimaryPart end
		return obj:FindFirstChildWhichIsA("BasePart")
	end
	return nil
end

local function setupPad(padObject)
	local padPart = getMainPart(padObject)
	if not padPart then return end

	-- üßπ CLEANUP
	for _, child in pairs(padPart:GetChildren()) do
		if child:IsA("ProximityPrompt") and child.Name == "ProximityPrompt" then
			child:Destroy()
		end
	end

	-- 1. SETUP VALUES
	local occupiedVal = padPart:FindFirstChild("IsOccupied")
	if not occupiedVal then
		occupiedVal = Instance.new("BoolValue"); occupiedVal.Name = "IsOccupied"; occupiedVal.Parent = padPart
	end

	local linkedCarVal = padPart:FindFirstChild("LinkedCar")
	if not linkedCarVal then
		linkedCarVal = Instance.new("ObjectValue"); linkedCarVal.Name = "LinkedCar"; linkedCarVal.Parent = padPart
	end

	-- 2. SETUP PROMPTS
	local placePrompt = padPart:FindFirstChild("PlacePrompt")
	if not placePrompt then
		placePrompt = Instance.new("ProximityPrompt")
		placePrompt.Name = "PlacePrompt"
		placePrompt.ActionText = "Place Car"
		placePrompt.ObjectText = "Car Pad"
		placePrompt.HoldDuration = 0.5
		placePrompt.MaxActivationDistance = PROMPT_RANGE 
		placePrompt.RequiresLineOfSight = false 
		placePrompt.Parent = padPart
	end

	local pickupPrompt = padPart:FindFirstChild("PickupPrompt")
	if not pickupPrompt then
		pickupPrompt = Instance.new("ProximityPrompt")
		pickupPrompt.Name = "PickupPrompt"
		pickupPrompt.ActionText = "Pick Up"
		pickupPrompt.ObjectText = "Occupied Pad"
		pickupPrompt.HoldDuration = 0.5
		pickupPrompt.MaxActivationDistance = PROMPT_RANGE 
		pickupPrompt.RequiresLineOfSight = false 
		pickupPrompt.Enabled = false 
		pickupPrompt.Parent = padPart
	end

	if occupiedVal.Value == true then
		placePrompt.Enabled = false
		pickupPrompt.Enabled = true
	else
		placePrompt.Enabled = true
		pickupPrompt.Enabled = false
	end

	local isProcessing = false

	-- =========================================================================
	-- üü¢ PLACE LOGIC
	-- =========================================================================
	placePrompt.Triggered:Connect(function(player)
		if isProcessing then return end
		if occupiedVal.Value == true then return end

		isProcessing = true 

		local thisPlot = getPlotFolder(padObject)
		if not thisPlot then isProcessing = false; return end

		local myAssignedPlot = player:GetAttribute("OccupiedPlot")
		if myAssignedPlot ~= thisPlot.Name then
			warn("‚õî ACCESS DENIED.")
			isProcessing = false; return 
		end

		local tool = player.Character:FindFirstChildWhichIsA("Tool")
		if tool then
			local cleanName = tool.Name:gsub(" Item", ""):gsub("Item", "")
			local realCar = CarModels:FindFirstChild(cleanName)

			if realCar then
				occupiedVal.Value = true
				placePrompt.Enabled = false
				pickupPrompt.Enabled = true

				tool:Destroy()

				local placedCar = realCar:Clone()
				local padTop = padPart.CFrame * CFrame.new(0, (padPart.Size.Y / 2) + VERTICAL_OFFSET + 1, 0)
				placedCar:PivotTo(padTop)

				local carFolder = thisPlot:FindFirstChild("PlacedCars")
				if carFolder then placedCar.Parent = carFolder else placedCar.Parent = thisPlot end

				local soundFolder = game.ReplicatedStorage:FindFirstChild("GameSounds")
				if soundFolder and soundFolder:FindFirstChild("PlaceSound") then
					local sClone = soundFolder.PlaceSound:Clone()
					sClone.Parent = padPart
					sClone:Play()
					Debris:AddItem(sClone, 2)
				end

				-- Ghost Mode
				for _, part in pairs(placedCar:GetDescendants()) do
					if part:IsA("BasePart") then
						part.Anchored = true; part.CanCollide = false
					end
				end

				linkedCarVal.Value = placedCar
				print("‚úÖ Car placed: " .. cleanName)
			else
				warn("‚ùå Model not found: " .. cleanName)
				occupiedVal.Value = false
				placePrompt.Enabled = true
			end
		end

		task.wait(0.2)
		isProcessing = false
	end)

	-- =========================================================================
	-- üî¥ PICKUP LOGIC (REFACTORED)
	-- =========================================================================
	pickupPrompt.Triggered:Connect(function(player)
		if isProcessing then return end
		isProcessing = true

		local thisPlot = getPlotFolder(padObject)
		local myAssignedPlot = player:GetAttribute("OccupiedPlot")

		if not thisPlot or myAssignedPlot ~= thisPlot.Name then 
			isProcessing = false; return 
		end

		local carToRemove = linkedCarVal.Value

		if carToRemove then
			local carName = carToRemove.Name
			local foundTool = nil
			
			-- ‚úÖ Names to check (e.g. "Delta Item", "Delta", "DeltaItem")
			local possibleNames = {carName .. " Item", carName .. "Item", carName}

			-- üîé SEARCH 1: Check CarTools folder directly (FAST & RELIABLE)
			for _, name in ipairs(possibleNames) do
				local t = CarTools:FindFirstChild(name)
				if t and t:IsA("Tool") then
					foundTool = t:Clone()
					break
				end
			end

			-- üîé SEARCH 2: Fallback to StarterPack if not in CarTools
			if not foundTool then
				for _, name in ipairs(possibleNames) do
					local t = StarterPack:FindFirstChild(name)
					if t and t:IsA("Tool") then
						foundTool = t:Clone()
						break
					end
				end
			end

			-- ‚úÖ GIVE TOOL
			if foundTool then
				foundTool.Parent = player.Backpack
				carToRemove:Destroy()

				occupiedVal.Value = false
				linkedCarVal.Value = nil

				placePrompt.Enabled = true
				pickupPrompt.Enabled = false

				local soundFolder = game.ReplicatedStorage:FindFirstChild("GameSounds")
				if soundFolder and soundFolder:FindFirstChild("EquipSound") then
					local sClone = soundFolder.EquipSound:Clone()
					sClone.Parent = padPart
					sClone:Play()
					Debris:AddItem(sClone, 2)
				end
				print("‚ôªÔ∏è Picked up: " .. carName .. " (Tool Given)")
			else
				warn("‚ùå CRITICAL: Could not find tool for '" .. carName .. "' in ServerStorage.CarTools!")
			end
		else
			-- Reset if car was already gone
			occupiedVal.Value = false
			placePrompt.Enabled = true
			pickupPrompt.Enabled = false
		end

		task.wait(0.2)
		isProcessing = false
	end)
end

-- üîÑ LOOP
for _, plot in pairs(TycoonFolder:GetChildren()) do
	local padsFolder = plot:FindFirstChild("Pads")
	if padsFolder then
		for _, pad in pairs(padsFolder:GetChildren()) do
			setupPad(pad)
		end
	end
end
