-- [[ SERVER SCRIPT: DeepSystemDebugger (V3 - Final Hierarchy Fix) ]]
-- -- Indicating what the script is for: Final verification of Plots 1-6 with smart hierarchy detection.
-- STATUS: Updated to support 'Revenue-indicator' folders.

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

-- ‚öôÔ∏è CONFIGURATION
local TYCOON_FOLDER_NAME = "Tycoons"
local EXPECTED_PLOT_COUNT = 6 

-- ============================================================================
-- üïµÔ∏è SMART CHECK FUNCTIONS
-- ============================================================================

local function VerifyRevenueGUI(model, earningsPart, logs)
	-- CHECK 1: Is it inside the 'Earnings' part? (Old Style)
	if earningsPart:FindFirstChild("RevenueGUI") then
		return true
	end

	-- CHECK 2: Is it inside 'Revenue-indicator' model? (New Style)
	-- Your TabletServerHandler specifically checks for this folder [Source: 310]
	local indicatorFolder = model:FindFirstChild("Revenue-indicator")
	if indicatorFolder then
		if indicatorFolder:FindFirstChild("RevenueGUI") then
			return true
		end
	end

	-- FAIL: Found nowhere
	table.insert(logs, "‚ùå MISSING: 'RevenueGUI' (Checked 'Earnings' part AND 'Revenue-indicator' folder)")
	return false
end

local function RunDeepDiagnosis()
	print(" ")
	print("==============================================================")
	print("üõ†Ô∏è  STARTING FINAL SYSTEM DIAGNOSIS (V3)  üõ†Ô∏è")
	print("==============================================================")

	local TycoonFolder = Workspace:FindFirstChild(TYCOON_FOLDER_NAME)
	if not TycoonFolder then
		warn("üö® FATAL: Folder '"..TYCOON_FOLDER_NAME.."' NOT FOUND!")
		return
	end

	local plots = TycoonFolder:GetChildren()
	local totalErrors = 0
	local plotCount = #plots

	print("‚ÑπÔ∏è Found " .. plotCount .. " Plots.")

	for _, plot in pairs(plots) do
		local plotErrors = {}
		local plotName = plot.Name

		-- 1. BASIC ESSENTIALS
		if not plot:FindFirstChild("Owner") then table.insert(plotErrors, "MISSING: Owner Value") end
		if not plot:FindFirstChild("PendingEarnings") then table.insert(plotErrors, "MISSING: PendingEarnings") end
		if not plot:FindFirstChild("SpawnPoint") then table.insert(plotErrors, "MISSING: SpawnPoint") end

		-- 2. TABLET SYSTEM (The Complex Part)
		local claimModel = plot:FindFirstChild("ClaimEarnings")
		if claimModel then
			-- Check ClaimPart
			local claimPart = claimModel:FindFirstChild("ClaimPart")
			if claimPart then
				if not claimPart:FindFirstChild("ClaimGUI") then
					table.insert(plotErrors, "MISSING: ClaimPart > ClaimGUI")
				end
			else
				table.insert(plotErrors, "MISSING: ClaimEarnings > ClaimPart")
			end

			-- Check Earnings Part
			local earningsPart = claimModel:FindFirstChild("Earnings")
			if earningsPart then
				if not earningsPart:FindFirstChild("AvatarGUI") then
					table.insert(plotErrors, "MISSING: Earnings > AvatarGUI")
				end
				if not earningsPart:FindFirstChild("UsernameGUI") then
					table.insert(plotErrors, "MISSING: Earnings > UsernameGUI")
				end

				-- üî• THE FIX: Smart Revenue Check
				VerifyRevenueGUI(claimModel, earningsPart, plotErrors)
			else
				table.insert(plotErrors, "MISSING: ClaimEarnings > Earnings")
			end
		else
			table.insert(plotErrors, "CRITICAL: 'ClaimEarnings' Model missing!")
		end

		-- 3. PAD SYSTEM
		local padsFolder = plot:FindFirstChild("Pads")
		if padsFolder then
			local pads = padsFolder:GetChildren()
			if #pads == 0 then
				table.insert(plotErrors, "‚ö†Ô∏è WARNING: 'Pads' folder is empty.")
			else
				for _, padObj in pairs(pads) do
					local padPart = padObj:IsA("Model") and (padObj.PrimaryPart or padObj:FindFirstChildWhichIsA("BasePart")) or padObj
					if padPart then
						if not padPart:FindFirstChild("IsOccupied") then table.insert(plotErrors, "Pad " .. padObj.Name .. " missing 'IsOccupied'") end
						if not padPart:FindFirstChild("LinkedCar") then table.insert(plotErrors, "Pad " .. padObj.Name .. " missing 'LinkedCar'") end
					end
				end
			end
		end

		-- 4. REPORT
		if #plotErrors == 0 then
			print("‚úÖ " .. plotName .. ": VERIFIED & READY.")
		else
			totalErrors = totalErrors + 1
			warn("üõë " .. plotName .. " FAILURES:")
			for _, err in ipairs(plotErrors) do
				print("   " .. err)
			end
		end
	end

	print("==============================================================")
	if totalErrors == 0 then
		print("üåü FINAL VERDICT: ALL SYSTEMS GO. üåü")
		print("   (Your hierarchy matches the scripts perfectly. Safe to publish.)")
	else
		warn("üö© VERIFICATION FAILED: " .. totalErrors .. " plots still have issues.")
	end
	print("==============================================================")
end

-- ‚è≥ AUTO-RUN
task.wait(2)
RunDeepDiagnosis()
