-- [[ SERVER SCRIPT: TycoonEconomy (Friend Bonus + Accumulator Fix + SKINS) ]]
-- [[ UPDATED: Added Friend Multiplier (10% per friend, max 50%) ]]
-- [[ UPDATED: Added Skin Multiplier (e.g. 25% for Gold) ]]
-- [[ FIXES: "Zero Income" Bug, Name Mismatch Lookup, API Lag Prevention ]]

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")

local CarStats = require(ReplicatedStorage:WaitForChild("CarStats"))
local BaseSkinStats = require(ReplicatedStorage:WaitForChild("BaseSkinStats")) -- âœ… Added Module
local TycoonFolder = Workspace:WaitForChild("Tycoons")

local PAY_INTERVAL = 1
local profitAccumulator = {} 
local FriendCache = {} -- [UserId] = { [FriendId] = true }

-- ============================================================================
-- ðŸŽï¸ CAR STATS LOOKUP CACHE (O(1) Access)
-- ============================================================================
local CarLookup = {}
for id, stats in pairs(CarStats.Cars) do
	CarLookup[id] = stats -- Key Lookup
	CarLookup[stats.Name] = stats -- Name Lookup
end

-- ============================================================================
-- ðŸ‘¥ FRIEND BONUS SYSTEM (OPTIMIZED O(N))
-- ============================================================================

local function updateMultiplier(player)
	if not player or not FriendCache[player.UserId] then return end

	local count = 0
	for _ in pairs(FriendCache[player.UserId]) do count += 1 end

	local clamped = math.min(count, 5)
	local mult = 1 + (clamped * 0.10)

	player:SetAttribute("ActiveFriends", count)
	player:SetAttribute("FriendMultiplier", mult)
end

local function onPlayerAdded(player)
	local uid = player.UserId
	FriendCache[uid] = {}

	task.spawn(function()
		for _, other in ipairs(Players:GetPlayers()) do
			if other ~= player then
				local oid = other.UserId
				local success, isFriend = pcall(function() return player:IsFriendsWith(oid) end)

				if success and isFriend then
					-- Add to BOTH caches
					if FriendCache[uid] then FriendCache[uid][oid] = true end
					if FriendCache[oid] then FriendCache[oid][uid] = true end

					updateMultiplier(player)
					updateMultiplier(other)
				end
			end
		end
		updateMultiplier(player) -- Ensure init even with 0 friends
	end)
end

local function onPlayerRemoving(player)
	local uid = player.UserId
	if FriendCache[uid] then
		for friendId, _ in pairs(FriendCache[uid]) do
			local friend = Players:GetPlayerByUserId(friendId)
			if friend and FriendCache[friendId] then
				FriendCache[friendId][uid] = nil
				updateMultiplier(friend)
			end
		end
		FriendCache[uid] = nil
	end
end

Players.PlayerAdded:Connect(onPlayerAdded)
Players.PlayerRemoving:Connect(onPlayerRemoving)

-- Init existing
for _, p in ipairs(Players:GetPlayers()) do onPlayerAdded(p) end

-- ============================================================================
-- ðŸ† SKIN MULTIPLIER HELPER
-- ============================================================================
local function GetSkinMultiplier(player)
	if not player then return 1 end

	-- Read the attribute set by TransactionHandler/DataHandler
	local skinName = player:GetAttribute("EquippedSkin")

	if skinName and BaseSkinStats[skinName] then
		return BaseSkinStats[skinName].Multiplier or 1
	end
	return 1 -- Default (No Boost)
end

-- ============================================================================
-- ðŸ’° MAIN ECONOMY LOOP
-- ============================================================================

local function getLinkedCarValue(pad)
	local direct = pad:FindFirstChild("LinkedCar")
	if direct then return direct.Value end

	if pad:IsA("Model") and pad.PrimaryPart then
		local prim = pad.PrimaryPart:FindFirstChild("LinkedCar")
		if prim then return prim.Value end
	end

	for _, child in pairs(pad:GetChildren()) do
		local val = child:FindFirstChild("LinkedCar")
		if val then return val.Value end
	end
	return nil
end

task.spawn(function()
	print("ðŸ’° TycoonEconomy: System Active & Monitoring...")

	while true do
		task.wait(PAY_INTERVAL)

		for _, plot in pairs(TycoonFolder:GetChildren()) do
			local pendingValue = plot:FindFirstChild("PendingEarnings")
			local padsFolder = plot:FindFirstChild("Pads")
			local ownerValue = plot:FindFirstChild("Owner") -- Needed to find the player

			if pendingValue and padsFolder then
				local plotTotalCPS = 0

				-- 1. Calculate Base Income from Cars
				for _, pad in pairs(padsFolder:GetChildren()) do
					local linkedCar = getLinkedCarValue(pad)

					if linkedCar and linkedCar.Parent then
						-- [[ AUDIT FIX: O(1) LOOKUP ]]
						-- Uses the pre-computed CarLookup table instead of linear search
						local stats = CarLookup[linkedCar.Name]

						if stats then
							plotTotalCPS = plotTotalCPS + stats.CPS
						else
							if not pad:GetAttribute("WarnedMissing") then
								warn("âš ï¸ Economy Warning: No stats found for '" .. linkedCar.Name .. "'")
								pad:SetAttribute("WarnedMissing", true)
							end
						end
					end
				end

				-- 2. Apply Multipliers (Friends + Skins)
				local friendMultiplier = 1
				local skinMultiplier = 1

				if ownerValue and ownerValue.Value ~= "" then
					local player = Players:FindFirstChild(ownerValue.Value)
					if player then
						-- A. Friend Bonus
						local bonus = player:GetAttribute("FriendMultiplier")
						if bonus then friendMultiplier = bonus end

						-- B. Skin Bonus (Gold Upgrade) âœ… NEW
						skinMultiplier = GetSkinMultiplier(player)
					end
				end

				-- Apply the bonuses: (Base * Friend) * Skin
				-- Example: (100 CPS * 1.5 Friend) * 1.25 Gold = 187.5 CPS
				plotTotalCPS = (plotTotalCPS * friendMultiplier) * skinMultiplier

				-- 3. Accumulate and Payout
				if not profitAccumulator[plot] then profitAccumulator[plot] = 0 end
				profitAccumulator[plot] = profitAccumulator[plot] + plotTotalCPS

				local payout = math.floor(profitAccumulator[plot])

				if payout > 0 then
					pendingValue.Value = pendingValue.Value + payout
					profitAccumulator[plot] = profitAccumulator[plot] - payout
				end

				-- Update attribute so TabletHandler sees the Boosted CPS
				plot:SetAttribute("CurrentCPS", plotTotalCPS)
			end
		end
	end
end)
