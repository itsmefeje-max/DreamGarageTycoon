-- [[ SERVER SCRIPT: TycoonEconomy (Accumulator Fix & Audit Fixed) ]]
-- [[ FIXES: "Zero Income" Bug, Name Mismatch Lookup ]]

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")

local CarStats = require(ReplicatedStorage:WaitForChild("CarStats"))
local TycoonFolder = Workspace:WaitForChild("Tycoons")

local PAY_INTERVAL = 1
local profitAccumulator = {} 

local function getLinkedCarValue(pad)
	local direct = pad:FindFirstChild("LinkedCar")
	if direct then return direct.Value end

	if pad:IsA("Model") and pad.PrimaryPart then
		local prim = pad.PrimaryPart:FindFirstChild("LinkedCar")
		if prim then return prim.Value end
	end

	for _, child in pairs(pad:GetChildren()) do
		local val = child:FindFirstChild("LinkedCar")
		if val then return val.Value end
	end
	return nil
end

task.spawn(function()
	print("ðŸ’° TycoonEconomy: System Active & Monitoring...")

	while true do
		task.wait(PAY_INTERVAL)

		for _, plot in pairs(TycoonFolder:GetChildren()) do
			local pendingValue = plot:FindFirstChild("PendingEarnings")
			local padsFolder = plot:FindFirstChild("Pads")

			if pendingValue and padsFolder then
				local plotTotalCPS = 0

				for _, pad in pairs(padsFolder:GetChildren()) do
					local linkedCar = getLinkedCarValue(pad)

					if linkedCar and linkedCar.Parent then
						-- [[ AUDIT FIX: ROBUST LOOKUP ]]
						local stats = CarStats.Cars[linkedCar.Name]

						-- Fallback: Search by Display Name if direct key fails
						if not stats then
							for _, s in pairs(CarStats.Cars) do
								if s.Name == linkedCar.Name then
									stats = s
									break
								end
							end
						end

						if stats then
							plotTotalCPS = plotTotalCPS + stats.CPS
						else
							if not pad:GetAttribute("WarnedMissing") then
								warn("âš ï¸ Economy Warning: No stats found for '" .. linkedCar.Name .. "'")
								pad:SetAttribute("WarnedMissing", true)
							end
						end
					end
				end

				if not profitAccumulator[plot] then profitAccumulator[plot] = 0 end
				profitAccumulator[plot] = profitAccumulator[plot] + plotTotalCPS

				local payout = math.floor(profitAccumulator[plot])

				if payout > 0 then
					pendingValue.Value = pendingValue.Value + payout
					profitAccumulator[plot] = profitAccumulator[plot] - payout
				end

				plot:SetAttribute("CurrentCPS", plotTotalCPS)
			end
		end
	end
end)
