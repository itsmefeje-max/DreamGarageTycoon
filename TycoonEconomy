-- ( SERVER SCRIPT: TycoonEconomy - SUFFIX UPDATE )
-- Handles: Car Earnings Generation & Floating Text (With K/M/B Suffixes)

local ServerStorage = game:GetService("ServerStorage")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

local CarStats = require(ServerStorage:WaitForChild("CarStats"))
local TycoonFolder = Workspace:WaitForChild("Tycoons")

-- ‚öôÔ∏è SETTINGS
local PAY_INTERVAL = 1 -- Seconds

-- üìä ABBREVIATION HELPER
local SUFFIXES = {"K", "M", "B", "T", "Qa", "Qi", "Sx", "Sp", "Oc", "No", "Dc"}

local function formatNumber(n)
	n = tonumber(n)
	if not n then return "0" end
	if n < 1000 then return tostring(math.floor(n)) end
	local i = math.floor(math.log(n, 1000))
	local v = math.pow(1000, i)
	local suffix = SUFFIXES[i] or "?"
	return string.format("%.2f%s", n / v, suffix)
end

-- üõ†Ô∏è FUNCTION: Create Floating UI
local function addCashUI(carModel, cpsAmount)
	-- Clean up old UI
	local existing = carModel:FindFirstChild("CashBillboard")
	if existing then existing:Destroy() end

	local bb = Instance.new("BillboardGui")
	bb.Name = "CashBillboard"
	bb.Adornee = carModel.PrimaryPart or carModel:FindFirstChildWhichIsA("BasePart")
	bb.Size = UDim2.new(0, 100, 0, 50)
	bb.StudsOffset = Vector3.new(0, 6, 0)
	bb.AlwaysOnTop = true
	bb.Parent = carModel

	local txt = Instance.new("TextLabel")
	txt.Parent = bb
	txt.Size = UDim2.new(1, 0, 1, 0)
	txt.BackgroundTransparency = 1
	-- ‚úÖ UPDATE: Now uses formatNumber!
	txt.Text = "+$" .. formatNumber(cpsAmount) .. "/s"
	txt.TextColor3 = Color3.fromRGB(85, 255, 127) 
	txt.TextStrokeTransparency = 0
	txt.Font = Enum.Font.FredokaOne
	txt.TextSize = 20
end

-- üõ†Ô∏è FUNCTION: Setup Pad Listener
local function setupPadListener(pad)
	local linkedCarVal = pad:WaitForChild("LinkedCar", 5)
	if not linkedCarVal then return end

	linkedCarVal.Changed:Connect(function(newCar)
		if newCar and newCar:IsA("Model") then
			local carName = newCar.Name
			local stats = CarStats.Cars[carName]
			if stats then
				addCashUI(newCar, stats.CPS)
			end
		end
	end)
end

-- üîÑ INITIALIZATION
for _, plot in pairs(TycoonFolder:GetChildren()) do
	if not plot:FindFirstChild("PendingEarnings") then
		local pendingInt = Instance.new("IntValue")
		pendingInt.Name = "PendingEarnings"
		pendingInt.Value = 0
		pendingInt.Parent = plot
	end

	local padsFolder = plot:FindFirstChild("Pads")
	if padsFolder then
		for _, pad in pairs(padsFolder:GetChildren()) do
			setupPadListener(pad)
		end
	end
end

-- üí∞ MAIN LOOP
task.spawn(function()
	while true do
		task.wait(PAY_INTERVAL)
		for _, plot in pairs(TycoonFolder:GetChildren()) do
			local pendingValue = plot:FindFirstChild("PendingEarnings")
			local padsFolder = plot:FindFirstChild("Pads")

			if pendingValue and padsFolder then
				local plotTotalIncome = 0
				for _, pad in pairs(padsFolder:GetChildren()) do
					local linkedCar = pad:FindFirstChild("LinkedCar") and pad.LinkedCar.Value
					if linkedCar and linkedCar.Parent then
						local stats = CarStats.Cars[linkedCar.Name]
						if stats then
							plotTotalIncome = plotTotalIncome + stats.CPS
						end
					end
				end
				if plotTotalIncome > 0 then
					pendingValue.Value = pendingValue.Value + plotTotalIncome
				end
			end
		end
	end
end)
