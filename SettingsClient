-- [[ LOCAL SCRIPT: SettingsClient (CENTERED POP) ]]
-- Purpose: Settings UI + Music Toggle + Center Pop Animation
-- Runs on: Client (StarterPlayerScripts or StarterGui)
-- Location: StarterGui/SettingsGui
-- Dependencies: SoundService, TweenService, Debris
-- Public API: None (Internal Logic)
-- Networking: None (Client-side UI logic only)
-- Security: N/A (Visuals only)
-- Performance: Tweens used for animations; Sound debris cleanup included.
-- Notes: Hover sounds removed per request. Visual hovers retained.

local Players = game:GetService("Players")
local SoundService = game:GetService("SoundService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Debris = game:GetService("Debris")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- üõ†Ô∏è REFERENCES
local screenGui = script.Parent
local openButton = screenGui:WaitForChild("OpenButton")
local window = screenGui:WaitForChild("SettingsWindow")
local closeButton = window:WaitForChild("CloseButton")

-- üéµ MUSIC BUTTONS
local btnMusicOn = window:WaitForChild("MusicOnButton")
local btnMusicOff = window:WaitForChild("MusicOffButton")

-- üîä MUSIC TARGET
local gameTheme = SoundService:WaitForChild("GameTheme", 5)

-- ‚öôÔ∏è CONFIG
local CONFIG = {
	Colors = {
		Hover = Color3.fromRGB(210, 210, 210),
		Normal = Color3.fromRGB(255, 255, 255)
	},
	Sounds = {
		Open  = "rbxassetid://9083627113",
		Click = "rbxassetid://9083627113",
	},
	DefaultVolume = 0.5,

	-- Animation Settings
	Anim = {
		OpenTime = 1.0,   -- [UPDATED] 1 Second
		CloseTime = 1.0,  -- [UPDATED] 1 Second
		StartScale = 0.0, -- [UPDATED] Starts at 0 size to prevent "snapping" when closing
		EasingStyle = Enum.EasingStyle.Exponential, -- [UPDATED] Smoother for long animations
	},
}

-- üîä SFX HELPER
local function playUiSound(name)
	local id = CONFIG.Sounds[name]
	if not id then return end

	local s = Instance.new("Sound")
	s.SoundId = id
	s.Volume = 0.5
	s.Parent = SoundService
	s:Play()
	Debris:AddItem(s, 2)
end

-- ‚úÖ ENSURE UISCALE EXISTS
local uiScale = window:FindFirstChildOfClass("UIScale")
if not uiScale then
	uiScale = Instance.new("UIScale")
	uiScale.Parent = window
end

-- ‚úÖ FORCE CENTER ANCHORING
window.AnchorPoint = Vector2.new(0.5, 0.5)
window.Position = UDim2.new(0.5, 0, 0.5, 0)

-- üü¢ HIDE/RESTORE OTHER GUIS
local function setOtherGuisEnabled(enabled)
	for _, gui in ipairs(playerGui:GetChildren()) do
		if gui:IsA("ScreenGui") and gui ~= screenGui and gui.Name ~= "TouchGui" then
			if enabled == false then
				if gui:GetAttribute("WasEnabled") == nil then
					gui:SetAttribute("WasEnabled", gui.Enabled)
				end
				gui.Enabled = false
			else
				local was = gui:GetAttribute("WasEnabled")
				if was ~= nil then
					gui.Enabled = was
					gui:SetAttribute("WasEnabled", nil)
				end
			end
		end
	end
end

-- üü¢ WINDOW VISIBILITY (Centered Pop)
local currentTween = nil

local function setWindowVisible(isOpen)
	if currentTween then currentTween:Cancel() end
	local A = CONFIG.Anim

	if isOpen then
		-- 1. Setup
		window.Visible = true
		openButton.Visible = false
		uiScale.Scale = A.StartScale -- Sets scale to 0 initially

		playUiSound("Open")
		setOtherGuisEnabled(false)

		-- 2. Animate Scale to 1 (From Center)
		-- Uses 'Out' so it slows down as it reaches full size
		local info = TweenInfo.new(A.OpenTime, A.EasingStyle, Enum.EasingDirection.Out)
		currentTween = TweenService:Create(uiScale, info, { Scale = 1 })
		currentTween:Play()

	else
		-- 1. Animate Scale down (To Center)
		playUiSound("Click")

		-- Uses 'Out' direction here effectively too (Reversed In is tricky with Expon), 
		-- but 'Out' + 'Scale=0' usually looks cleanest for closing.
		-- Let's stick to standard logic: 'In' typically accelerates out.
		-- For 1 second, 'Quint' or 'Exponential' In/Out works best.
		local info = TweenInfo.new(A.CloseTime, A.EasingStyle, Enum.EasingDirection.In) 
		currentTween = TweenService:Create(uiScale, info, { Scale = A.StartScale }) -- Goes to 0
		currentTween:Play()

		-- 2. Cleanup
		currentTween.Completed:Connect(function(playbackState)
			if playbackState == Enum.PlaybackState.Completed then
				window.Visible = false
				openButton.Visible = true
				uiScale.Scale = 1 
				setOtherGuisEnabled(true)
			end
		end)
	end
end

-- üéµ MUSIC TOGGLE LOGIC
local function setMusicMuted(shouldBeMuted)
	btnMusicOn.Visible = not shouldBeMuted
	btnMusicOff.Visible = shouldBeMuted

	local vol = shouldBeMuted and 0 or CONFIG.DefaultVolume
	if gameTheme then gameTheme.Volume = vol end

	local shopMusic = SoundService:FindFirstChild("ShopMusic_Internal")
	if shopMusic then shopMusic.Volume = vol end

	playUiSound("Click")
end

-- üñ±Ô∏è BUTTON SETUP
local function setupButton(btn, onClick)
	if not btn or not btn:IsA("GuiButton") then return end

	if not UserInputService.TouchEnabled then
		btn.MouseEnter:Connect(function()
			TweenService:Create(btn, TweenInfo.new(0.12), { ImageColor3 = CONFIG.Colors.Hover }):Play()
		end)

		btn.MouseLeave:Connect(function()
			TweenService:Create(btn, TweenInfo.new(0.12), { ImageColor3 = CONFIG.Colors.Normal }):Play()
		end)
	end

	btn.MouseButton1Click:Connect(function()
		if onClick then onClick() end
	end)
end

-- üöÄ INITIALIZATION
setupButton(openButton, function() setWindowVisible(true) end)
setupButton(closeButton, function() setWindowVisible(false) end)
setupButton(btnMusicOn, function() setMusicMuted(true) end)
setupButton(btnMusicOff, function() setMusicMuted(false) end)

-- Default State
setMusicMuted(false)
window.Visible = false
openButton.Visible = true
