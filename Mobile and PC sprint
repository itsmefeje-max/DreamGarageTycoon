-- ( LOCAL SCRIPT: Universal Sprint - TOGGLE FIX )
-- Features: Toggle Button (Mobile) + Toggle Shift (PC) + DISABLES WHEN HOLDING ITEMS

local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")

local player = Players.LocalPlayer
local button = script.Parent -- The ImageButton

-- === CONFIGURATION ===
local WALK_SPEED = 16
local SPRINT_SPEED = 26

-- === STATE ===
local isSprinting = false

-- 1. VISIBILITY SETUP
-- Only show mobile button if touch is enabled
if UserInputService.TouchEnabled then
	button.Visible = true
else
	button.Visible = false 
end

-- üõ†Ô∏è HELPER: Change Speed
local function updateSpeed()
	local character = player.Character
	if character then
		local humanoid = character:FindFirstChild("Humanoid")
		if humanoid then
			-- üõë SAFETY CHECK: If holding a tool, NEVER sprint
			if character:FindFirstChildWhichIsA("Tool") then
				humanoid.WalkSpeed = WALK_SPEED -- Force walk speed
				return
			end

			-- Normal Logic
			humanoid.WalkSpeed = isSprinting and SPRINT_SPEED or WALK_SPEED
		end
	end

	-- Update Mobile Button Visuals
	if isSprinting then
		button.ImageTransparency = 0.5 -- Dim (Active)
	else
		button.ImageTransparency = 0 -- Bright (Inactive)
	end
end

-- üõ°Ô∏è MONITOR TOOLS (The Fix)
local function setupCharacter(character)
	local humanoid = character:WaitForChild("Humanoid", 10)
	if not humanoid then return end

	-- Function to check if we are holding something
	local function checkTools()
		if character:FindFirstChildWhichIsA("Tool") then
			-- ‚úã PLAYER IS HOLDING A CAR/ITEM
			isSprinting = false
			updateSpeed()
			
			-- Hide button so they can't try to sprint
			button.Visible = false
		else
			-- ‚úÖ HANDS ARE EMPTY
			updateSpeed() -- Just to be safe
			
			-- Show button again if on Mobile
			if UserInputService.TouchEnabled then
				button.Visible = true
			end
		end
	end

	-- Listen for Equipping (ChildAdded) and Unequipping (ChildRemoved)
	character.ChildAdded:Connect(checkTools)
	character.ChildRemoved:Connect(checkTools)
	
	-- Run once at start in case they spawn with a tool
	checkTools()
end

-- ============================================================================
-- üíª PC LOGIC (Tap Shift to Toggle)
-- ============================================================================
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end 

	-- Extra Check: Don't toggle if holding a tool
	local char = player.Character
	if char and char:FindFirstChildWhichIsA("Tool") then return end

	if input.KeyCode == Enum.KeyCode.LeftShift then
		isSprinting = not isSprinting
		updateSpeed()
	end
end)

-- ============================================================================
-- üì± MOBILE LOGIC (Tap Button to Toggle)
-- ============================================================================
button.MouseButton1Click:Connect(function()
	-- Extra Check: Don't toggle if holding a tool
	local char = player.Character
	if char and char:FindFirstChildWhichIsA("Tool") then return end

	isSprinting = not isSprinting
	updateSpeed()
end)

-- üõ°Ô∏è SAFETY: Reset on Respawn
player.CharacterAdded:Connect(function(char)
	isSprinting = false
	-- Reset visibility based on device
	if UserInputService.TouchEnabled then
		button.Visible = true
	else
		button.Visible = false
	end
	
	setupCharacter(char)
end)

-- Initial Setup
if player.Character then setupCharacter(player.Character) end
