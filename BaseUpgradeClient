-- [[ LOCAL SCRIPT: BaseUpgradeClient ]]
-- Purpose: Opens UI, Freezes Player, Blurs Screen, Hides FriendBoost, AND Handles Purchases.
-- Location: StarterPlayerScripts

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local MarketplaceService = game:GetService("MarketplaceService")

local player = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")
local Remotes = ReplicatedStorage:WaitForChild("ShopRemotes")

-- üì° NETWORKING
local OpenEvent = Remotes:WaitForChild("OpenBaseUpgrade")
local TransactionFunc = Remotes:WaitForChild("BaseUpgradeTransaction") -- ‚úÖ Added for Buying

-- üì¶ REQUIRE KIT (For Sound & Animations)
local Kit
pcall(function()
	Kit = require(ReplicatedStorage:WaitForChild("ShopFrontendKit", 5))
end)

-- ‚öôÔ∏è CONFIGURATION
local UI_NAME = "BaseUpgradeUI"
local FRAME_NAME = "MainFrame"
local SCROLLER_NAME = "UpgradeScroller" -- ‚úÖ Added for Shop
local CLOSE_BTN_NAME = "CloseButton"
local BLUR_SIZE = 24 

-- üõ°Ô∏è STATE TRACKING
local hiddenGuis = {} 
local hiddenObjects = {} 
local currentBlur = nil 

-- ============================================================================
-- üõ†Ô∏è HELPER FUNCTIONS (Preserved from your script)
-- ============================================================================

-- 1. BLUR EFFECT
local function setBlur(enable)
	if enable then
		if not currentBlur then
			currentBlur = Instance.new("BlurEffect")
			currentBlur.Size = 0
			currentBlur.Parent = Lighting
			currentBlur.Name = "UpgradeBlur"
		end
		TweenService:Create(currentBlur, TweenInfo.new(0.5), {Size = BLUR_SIZE}):Play()
	else
		if currentBlur then
			local t = TweenService:Create(currentBlur, TweenInfo.new(0.5), {Size = 0})
			t:Play()
			t.Completed:Connect(function()
				if currentBlur then currentBlur:Destroy() currentBlur = nil end
			end)
		end
	end
end

-- 2. HIDE SPECIFIC OBJECTS (Like FriendBoost)
local function toggleNamedGuiObjects(shouldHide, objectName)
	if shouldHide then
		for _, obj in pairs(PlayerGui:GetDescendants()) do
			if obj:IsA("GuiObject") and obj.Name == objectName and obj.Visible then
				obj.Visible = false
				table.insert(hiddenObjects, obj)
			end
		end
	else
		for _, obj in pairs(hiddenObjects) do
			if obj and obj.Parent and obj:IsA("GuiObject") then
				obj.Visible = true
			end
		end
		hiddenObjects = {}
	end
end

-- 3. HIDE OTHER SCREEN GUIS (Focus Mode)
local function toggleOtherGuis(shouldHide)
	local myGui = PlayerGui:FindFirstChild(UI_NAME)

	if shouldHide then
		hiddenGuis = {}
		for _, otherGui in pairs(PlayerGui:GetChildren()) do
			if otherGui:IsA("ScreenGui") 
				and otherGui ~= myGui 
				and otherGui.Enabled == true 
				and otherGui.Name ~= "Balance Indicator"
				and otherGui.Name ~= "TouchGui"
				and otherGui.Name ~= "Chat"
			then
				otherGui.Enabled = false
				table.insert(hiddenGuis, otherGui)
			end
		end
	else
		for _, otherGui in pairs(hiddenGuis) do
			if otherGui and otherGui.Parent then
				otherGui.Enabled = true
			end
		end
		hiddenGuis = {}
	end
end

-- 4. FREEZE PLAYER
local function setMovement(active)
	local char = player.Character
	if char and char:FindFirstChild("Humanoid") then
		if not active then
			-- FREEZE
			char.Humanoid.WalkSpeed = 0
			char.Humanoid.JumpPower = 0
		else
			-- UNFREEZE (Restore defaults)
			char.Humanoid.WalkSpeed = 16
			char.Humanoid.JumpPower = 50
		end
	end
end

-- ============================================================================
-- üõçÔ∏è NEW SHOP LOGIC (Integrated)
-- ============================================================================

local function ConnectCard(cardFrame, skinName)
	local buyFrame = cardFrame:FindFirstChild("BuyFrame")
	if not buyFrame then return end

	-- üíµ CASH BUTTON
	local btnCash = buyFrame:FindFirstChild("BuyForCash")
	if btnCash then
		-- Apply your "Dim" effect
		if Kit and Kit.Tween then
			Kit.Tween:SetupButton(btnCash, function()
				-- CLICK LOGIC
				local success, msg = TransactionFunc:InvokeServer(skinName, "Cash")
				if success then
					print("‚úÖ Bought with Cash!")
					-- Optional: Play success sound or update UI here
					if Kit and Kit.Sound then Kit.Sound:Play("Purchase") end
				else
					warn("‚ùå Purchase Failed: " .. tostring(msg))
					if Kit and Kit.Sound then Kit.Sound:Play("Error") end
				end
			end)
		end
	end

	-- üíé ROBUX BUTTON
	local btnRobux = buyFrame:FindFirstChild("BuyForRobux")
	if btnRobux then
		-- Apply your "Dim" effect
		if Kit and Kit.Tween then
			Kit.Tween:SetupButton(btnRobux, function()
				-- CLICK LOGIC
				TransactionFunc:InvokeServer(skinName, "Robux") 
			end)
		end
	end
end

local function SetupShop()
	local gui = PlayerGui:WaitForChild(UI_NAME, 5)
	if not gui then return end

	local scroller = gui:FindFirstChild(SCROLLER_NAME, true) -- Finds recursive
	if not scroller then return end -- Might not be loaded yet

	-- 1. CONNECT CARD 1 (Gold)
	local card1 = scroller:FindFirstChild("Card1")
	if card1 then
		ConnectCard(card1, "Gold") 
	end
end

-- ============================================================================
-- üîÑ MAIN VISIBILITY TOGGLE (Integrated)
-- ============================================================================
local function setVisible(isOpen)
	local gui = PlayerGui:WaitForChild(UI_NAME, 5)
	if not gui then return warn("‚ö†Ô∏è BaseUpgradeUI not found") end

	local frame = gui:WaitForChild(FRAME_NAME, 5)
	if not frame then return warn("‚ö†Ô∏è MainFrame not found") end

	if isOpen then
		-- OPENING SEQUENCE
		toggleOtherGuis(true)
		toggleNamedGuiObjects(true, "FriendBoost") -- ‚úÖ Hides Friend Boost
		setBlur(true)                              -- ‚úÖ Adds Blur
		setMovement(false)                         -- ‚úÖ Stops Player

		-- ‚úÖ Initialize Buttons when opening (Just in case they reset)
		SetupShop()

		gui.Enabled = true
		frame.Visible = true

		if Kit and Kit.Sound then Kit.Sound:Play("Open") end
	else
		-- CLOSING SEQUENCE
		gui.Enabled = false
		frame.Visible = false

		setBlur(false)
		toggleOtherGuis(false)
		toggleNamedGuiObjects(false, "FriendBoost")
		setMovement(true) -- ‚úÖ Restores Movement
	end
end

-- üì° LISTEN FOR SERVER
OpenEvent.OnClientEvent:Connect(function()
	setVisible(true)
end)

-- ‚ùå CLOSE BUTTON LOGIC & STARTUP
task.spawn(function()
	local gui = PlayerGui:WaitForChild(UI_NAME, 10)
	if not gui then return end

	-- ‚úÖ FORCE HIDE ON JOIN (Fixes "Visible in Studio" issue)
	gui.Enabled = false 
	local frame = gui:WaitForChild(FRAME_NAME, 10)
	if frame then frame.Visible = false end

	-- Setup Button
	local closeBtn = frame and frame:WaitForChild(CLOSE_BTN_NAME, 10)
	if not closeBtn then return end

	if Kit and Kit.Tween and Kit.Tween.SetupButton then
		Kit.Tween:SetupButton(closeBtn, function() setVisible(false) end)
	else
		closeBtn.MouseButton1Click:Connect(function() setVisible(false) end)
	end

	-- Initial Shop Setup
	SetupShop()
end)
