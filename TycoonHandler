-- Purpose: Manages plot assignment in a strict ascending sequence, wiping, and safe releasing on leave.
-- Runs on: Server
-- Location: ServerScriptService
-- Dependencies: Workspace.Tycoons
-- Public API: N/A
-- Networking: N/A
-- Security: Server-authoritative plot assignment to prevent double-claiming.
-- Performance: Lightweight table sort on player join; event-based data saving locks.
-- Notes: Assumes tycoons are named sequentially (e.g., "Tycoon1", "Tycoon2").

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ServerStorage = game:GetService("ServerStorage")

local TycoonFolder = Workspace:WaitForChild("Tycoons")

-- üîó SYNC EVENT (Communication with TycoonDataHandler)
local SaveEvent = ServerStorage:FindFirstChild("TycoonSaveCompleted")
if not SaveEvent then
	SaveEvent = Instance.new("BindableEvent")
	SaveEvent.Name = "TycoonSaveCompleted"
	SaveEvent.Parent = ServerStorage
end

-- üßπ HELPER: Completely reset a plot
local function wipePlot(plot)
	print("üßπ Wiping Plot: " .. plot.Name)
	if plot:FindFirstChild("Owner") then plot.Owner.Value = "" end

	local pending = plot:FindFirstChild("PendingEarnings")
	if pending then pending.Value = 0 end

	-- Clear Saved CPS Attribute
	plot:SetAttribute("CurrentCPS", 0)

	-- Clean Entities
	if plot:FindFirstChild("PlacedCars") then plot.PlacedCars:ClearAllChildren() end

	-- Reset Pads
	if plot:FindFirstChild("Pads") then
		for _, padObj in pairs(plot.Pads:GetChildren()) do
			local padPart = padObj:IsA("Model") and (padObj.PrimaryPart or padObj:FindFirstChildWhichIsA("BasePart")) or padObj
			if padPart then
				local occupied = padPart:FindFirstChild("IsOccupied")
				if occupied then occupied.Value = false end
				local linkedCar = padPart:FindFirstChild("LinkedCar")
				if linkedCar then linkedCar.Value = nil end

				local place = padPart:FindFirstChild("PlacePrompt")
				local pickup = padPart:FindFirstChild("PickupPrompt")
				if place then place.Enabled = true end
				if pickup then pickup.Enabled = false end
			end
		end
	end
end

-- üè† ASSIGN PLOT (ASCENDING SEQUENCE FIX)
local function assignPlot(player)
	if player:GetAttribute("OccupiedPlot") then return end -- Already has one

	-- 1. Gather all plots
	local plots = TycoonFolder:GetChildren()

	-- 2. Sort plots alphabetically/numerically by Name (Ascending)
	table.sort(plots, function(a, b)
		return a.Name < b.Name
	end)

	-- 3. Loop through the sorted array using ipairs to respect the sequence
	for _, plot in ipairs(plots) do
		local ownerVal = plot:FindFirstChild("Owner")

		-- ‚úÖ CHECK: Only claim if owner string is empty
		if ownerVal and ownerVal.Value == "" then
			-- üõë WIPE NOW (Safe time to wipe: right before new owner takes it)
			wipePlot(plot)

			ownerVal.Value = player.Name
			player:SetAttribute("OccupiedPlot", plot.Name)

			local function onCharacterAdded(character)
				local spawnPart = plot:WaitForChild("SpawnPoint", 10)
				local hrp = character:WaitForChild("HumanoidRootPart", 10)
				if spawnPart and hrp then
					hrp.Anchored = true 
					character:PivotTo(spawnPart.CFrame + Vector3.new(0, 10, 0))
					task.wait(1.5) 
					hrp.Anchored = false
				end
			end

			player.CharacterAdded:Connect(onCharacterAdded)
			if player.Character then task.spawn(onCharacterAdded, player.Character) end
			return
		end
	end
end

Players.PlayerAdded:Connect(assignPlot)

Players.PlayerRemoving:Connect(function(player)
	local plotName = player:GetAttribute("OccupiedPlot")
	if plotName then
		local plot = TycoonFolder:FindFirstChild(plotName)
		if plot and plot:FindFirstChild("Owner") then

			print("üîí Locking " .. plotName .. " until data saves...")
			-- ‚ö†Ô∏è CRITICAL FIX: DO NOT clear Owner yet. 
			-- Clearing it now allows a new player to claim/wipe it while data is still saving!

			-- ‚è≥ EVENT LISTENER (The Senior Fix)
			local didSave = false
			local listener
			local waitStart = os.clock()

			-- 1. Check if ALREADY saved (Attribute Check)
			if player:GetAttribute("DataSaved") then
				didSave = true
			else
				-- 2. Listen for TycoonDataHandler to fire "TycoonSaveCompleted"
				listener = SaveEvent.Event:Connect(function(savedName)
					if savedName == player.Name then
						didSave = true
					end
				end)
			end

			-- WAIT LOOP: Wait until Saved OR Timeout (8 Seconds Failsafe)
			repeat 
				task.wait(0.1)
				if player:GetAttribute("DataSaved") then didSave = true end
			until didSave or (os.clock() - waitStart > 8)

			if listener then listener:Disconnect() end

			-- ‚úÖ NOW we safely release + clean the plot
			wipePlot(plot)
			print("üîì Released + wiped " .. plotName)

			if didSave then
				print("‚úÖ Data Saved for " .. player.Name .. ". Plot released safely.")
			else
				warn("‚ö†Ô∏è Save Timeout for " .. player.Name .. ". Forcing release of " .. plotName .. " (Data might be risky).")
			end

			-- QUEUE CHECK: Give to someone waiting
			for _, waitingPlayer in pairs(Players:GetPlayers()) do
				if not waitingPlayer:GetAttribute("OccupiedPlot") then
					assignPlot(waitingPlayer)
					if waitingPlayer:GetAttribute("OccupiedPlot") then break end
				end
			end
		end
	end
end)

-- Initial Loop
for _, player in pairs(Players:GetPlayers()) do assignPlot(player) end
