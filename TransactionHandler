-- [[ SERVER SIDE: TransactionHandler (Final Verified Fix) ]]
-- -- Indicating what the script is for: Withdraws money with exploit checks.
-- FIX: Added type checking for 'amount'.

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local withdrawEvent = ReplicatedStorage:WaitForChild("WithdrawEvent")

-- ‚è≥ COOLDOWN CONFIG
local COOLDOWN_TIME = 0.5 
local cooldowns = {} 

withdrawEvent.OnServerEvent:Connect(function(player, amount)
	-- üõ°Ô∏è SECURITY FIX: Type Check
	if type(amount) ~= "number" then 
		return -- Silently reject bad input
	end

	-- 1. Validate Amount
	if amount <= 0 then return end
	amount = math.floor(amount) 

	local leaderstats = player:FindFirstChild("leaderstats")
	if not leaderstats then return end

	-- 2. DEFINE VARIABLES
	local bank = leaderstats:FindFirstChild("Cash")   
	local wallet = leaderstats:FindFirstChild("Wallet") 

	if bank and wallet then

		-- 3. CHECK COOLDOWN
		local lastTime = cooldowns[player.UserId]
		if lastTime and (os.time() - lastTime) < COOLDOWN_TIME then
			warn("‚è≥ Transaction too fast for " .. player.Name)
			return 
		end

		-- 4. CHECK BALANCE
		if bank.Value >= amount then

			-- 5. DO THE TRANSFER
			bank.Value = bank.Value - amount   
			wallet.Value = wallet.Value + amount 

			-- Update Cooldown
			cooldowns[player.UserId] = os.time()

			print("‚úÖ Success! Withdrew $" .. amount .. " for " .. player.Name)
		else
			warn("‚ùå Insufficient Funds for " .. player.Name)
		end
	else
		warn("‚ùå CRITICAL: Missing stats for " .. player.Name)
	end
end)
