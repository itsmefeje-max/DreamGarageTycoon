
-- [[ SERVER SIDE: TransactionHandler (Verified) ]]
-- -- Indicating what the script is for: Securely transfers money from Bank to Wallet.
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

-- 1. REMOTE EVENT SETUP
local withdrawEvent = ReplicatedStorage:FindFirstChild("WithdrawEvent")
if not withdrawEvent then
	withdrawEvent = Instance.new("RemoteEvent")
	withdrawEvent.Name = "WithdrawEvent"
	withdrawEvent.Parent = ReplicatedStorage
	print("‚úÖ TransactionHandler: Created missing 'WithdrawEvent'")
end

-- ‚è≥ COOLDOWN CONFIG
local COOLDOWN_TIME = 0.5 
local cooldowns = {} 

withdrawEvent.OnServerEvent:Connect(function(player, amount)
	-- üõ°Ô∏è SECURITY FIX: Type Check
	if type(amount) ~= "number" then return end

	-- 1. Validate Amount
	amount = math.floor(amount) -- Remove decimals
	if amount <= 0 then return end

	local leaderstats = player:FindFirstChild("leaderstats")
	if not leaderstats then return end

	-- 2. DEFINE VARIABLES
	local bank = leaderstats:FindFirstChild("Cash")   
	local wallet = leaderstats:FindFirstChild("Wallet") 

	if bank and wallet then

		-- 3. CHECK COOLDOWN (High Precision)
		local currentTime = os.clock()
		local lastTime = cooldowns[player.UserId]

		if lastTime and (currentTime - lastTime) < COOLDOWN_TIME then
			return -- Silently ignore spam
		end

		-- 4. CHECK BALANCE
		if bank.Value >= amount then
			-- 5. DO THE TRANSFER
			bank.Value = bank.Value - amount   
			wallet.Value = wallet.Value + amount 

			-- Update Cooldown
			cooldowns[player.UserId] = currentTime
			print("‚úÖ Success! Withdrew $" .. amount .. " for " .. player.Name)
		else
			warn("‚ùå Insufficient Funds for " .. player.Name)
		end
	else
		warn("‚ùå CRITICAL: Missing stats for " .. player.Name)
	end
end)
