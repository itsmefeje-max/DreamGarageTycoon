-- [[ LOCAL SCRIPT: WithdrawLogic (FIXED & ROBUST) ]]
-- -- Indicating what the script is for: Handles Withdraw Button with "k/m/all" support and Pulse Animation.
-- UPDATED: Fixed input parsing so "1k", "1m", "all", and commas work perfectly.

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local SoundService = game:GetService("SoundService")
local Players = game:GetService("Players")

local player = Players.LocalPlayer
local withdrawBtn = script.Parent
-- Robust Parent Find: Ensure we get the Frame even if hierarchy changes slightly
local mainWindow = withdrawBtn.Parent 

local withdrawEvent = ReplicatedStorage:WaitForChild("WithdrawEvent", 10)
if not withdrawEvent then warn("‚ùå CRITICAL: WithdrawEvent missing in ReplicatedStorage!") end

-- üìÇ UI REFERENCES (Using Recursive Find for Safety)
local amountInput = mainWindow:FindFirstChild("AmountInput", true) 
local VerifyLabel = mainWindow:FindFirstChild("VerifyLabel", true) 
local SuccessLabel = mainWindow:FindFirstChild("SuccessLabel", true)
local ErrorLabel = mainWindow:FindFirstChild("ErrorLabel", true)

if not amountInput then warn("‚ùå CRITICAL: AmountInput textbox not found in Bank Frame!") end

-- üîä SOUND CONFIG
local CASH_SOUND_ID = "rbxassetid://140072726814802"
local ERROR_SOUND_ID = "rbxassetid://3779045779"

-- ‚öôÔ∏è STATE VARIABLES
local currentVerifyTween = nil 
local isCoolingDown = false 

-- ============================================================================
-- üõ†Ô∏è ANIMATION FUNCTIONS
-- ============================================================================

local function playSound(soundId)
	local sound = Instance.new("Sound")
	sound.SoundId = soundId
	sound.Volume = 1
	sound.Parent = SoundService 
	sound:Play()
	game.Debris:AddItem(sound, 3)
end

local function animateResult(uiObject)
	if not uiObject then return end

	-- 1. FORCE VISIBLE
	uiObject.Visible = true
	uiObject.ZIndex = 20 

	if uiObject:IsA("ImageLabel") then uiObject.ImageTransparency = 0 end
	if uiObject:IsA("TextLabel") then uiObject.TextTransparency = 0 end

	-- 2. Wait
	task.wait(2)

	-- 3. Fade Out
	local goals = {}
	if uiObject:IsA("ImageLabel") then goals.ImageTransparency = 1 end
	if uiObject:IsA("TextLabel") then goals.TextTransparency = 1 end

	local tweenOut = TweenService:Create(uiObject, TweenInfo.new(0.5), goals)
	tweenOut:Play()
	tweenOut.Completed:Wait()

	uiObject.Visible = false
end

local function startVerifying()
	if not VerifyLabel then return end

	-- Setup Start State
	VerifyLabel.Visible = true
	VerifyLabel.ZIndex = 20
	VerifyLabel.Rotation = 0 

	-- Start Invisible so we can fade it IN
	if VerifyLabel:IsA("ImageLabel") then VerifyLabel.ImageTransparency = 1 end
	if VerifyLabel:IsA("TextLabel") then VerifyLabel.TextTransparency = 1 end

	-- ‚ö° PULSE ANIMATION
	local pulseInfo = TweenInfo.new(0.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true)
	local goals = {}
	if VerifyLabel:IsA("ImageLabel") then goals.ImageTransparency = 0 end
	if VerifyLabel:IsA("TextLabel") then goals.TextTransparency = 0 end

	currentVerifyTween = TweenService:Create(VerifyLabel, pulseInfo, goals)
	currentVerifyTween:Play()
end

local function stopVerifying()
	if currentVerifyTween then
		currentVerifyTween:Cancel()
		currentVerifyTween = nil
	end
	if VerifyLabel then
		VerifyLabel.Visible = false
		if VerifyLabel:IsA("ImageLabel") then VerifyLabel.ImageTransparency = 0 end
	end
end

-- ============================================================================
-- üß† INPUT PARSING (THE FIX)
-- ============================================================================
local function parseAmount(text)
	if not text then return 0 end
	text = text:lower()
	
	-- Handle "All" or "Max"
	if text == "all" or text == "max" then
		if player.leaderstats and player.leaderstats:FindFirstChild("Cash") then
			return player.leaderstats.Cash.Value
		else
			return 0
		end
	end

	-- Remove commas
	text = text:gsub(",", "")

	-- Handle Suffixes
	local multiplier = 1
	if text:match("k") then multiplier = 1000 end
	if text:match("m") then multiplier = 1000000 end
	if text:match("b") then multiplier = 1000000000 end

	-- Extract Number
	local cleanNum = tonumber(text:match("[%d%.]+"))
	if cleanNum then
		return math.floor(cleanNum * multiplier)
	end
	
	return 0
end

-- ============================================================================
-- üü¢ MAIN BUTTON LOGIC
-- ============================================================================
withdrawBtn.MouseButton1Click:Connect(function()

	-- üõë 1. CHECK COOLDOWN
	if isCoolingDown then return end
	isCoolingDown = true 

	-- 2. DISABLE BUTTON VISUALLY
	withdrawBtn.Active = false
	withdrawBtn.AutoButtonColor = false

	-- 3. START VFX
	startVerifying()

	-- 4. WAIT (Simulate "Thinking")
	task.wait(1.5) -- Slightly faster than 2s for better feel

	-- 5. STOP VFX
	stopVerifying()

	-- 6. PARSE & CHECK
	local finalAmount = parseAmount(amountInput.Text)
	local currentBank = 0
	
	if player.leaderstats and player.leaderstats:FindFirstChild("Cash") then
		currentBank = player.leaderstats.Cash.Value
	end

	if (finalAmount <= 0) or (finalAmount > currentBank) then
		-- üî¥ FAIL
		print("‚ùå Transaction Failed: Invalid Amount or Insufficient Funds")
		playSound(ERROR_SOUND_ID)
		task.spawn(function() animateResult(ErrorLabel) end)
	else
		-- üü¢ SUCCESS
		print("‚úÖ Transaction Valid: Withdrawing " .. finalAmount)
		if withdrawEvent then
			withdrawEvent:FireServer(finalAmount)
		end
		playSound(CASH_SOUND_ID)
		task.spawn(function() animateResult(SuccessLabel) end)
		
		-- Clear input on success
		amountInput.Text = ""
	end

	-- üõë 7. EXTRA COOLDOWN
	task.wait(1)

	-- 8. UNLOCK BUTTON
	isCoolingDown = false
	withdrawBtn.Active = true
	withdrawBtn.AutoButtonColor = true
end)

-- Initialize
if VerifyLabel then VerifyLabel.Visible = false end
if SuccessLabel then SuccessLabel.Visible = false end
if ErrorLabel then ErrorLabel.Visible = false end
