-- [[ SERVER SCRIPT: TabletServerHandler ]]
-- Purpose: Handles Tablet updates & Secure Claiming.
-- FIX: AUTO-SEPARATES '$' from the Number so the '$' stays STAGNANT.

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local MarketplaceService = game:GetService("MarketplaceService")

-- ‚öôÔ∏è CONFIGURATION
local DEV_PRODUCT_ID = 3509697462
local TYCOON_FOLDER_NAME = "Tycoons"

-- üìÇ REFERENCES
local TycoonFolder = Workspace:WaitForChild(TYCOON_FOLDER_NAME)
local TabletEvent = ReplicatedStorage:FindFirstChild("TabletEvent") 

if not TabletEvent then
	TabletEvent = Instance.new("RemoteEvent")
	TabletEvent.Name = "TabletEvent"
	TabletEvent.Parent = ReplicatedStorage
end

-- üìä ABBREVIATION HELPER
local SUFFIXES = {"K", "M", "B", "T", "Qa", "Qi", "Sx", "Sp", "Oc", "No", "Dc"}
local function formatNumber(n)
	n = tonumber(n) or 0
	if n < 1000 then return tostring(math.floor(n)) end
	local i = math.floor(math.log(n, 1000))
	local v = math.pow(1000, i)
	local suffix = SUFFIXES[i] or "?"
	return string.format("%.2f%s", n / v, suffix)
end

-- ============================================================================
-- üõ†Ô∏è TABLET SETUP FUNCTION
-- ============================================================================
local function setupTablet(plot)
	task.spawn(function()
		-- 1. WAIT FOR HIERARCHY
		local model = plot:WaitForChild("ClaimEarnings", 30)
		if not model then return end

		local mainPart = model:WaitForChild("Earnings", 10)
		if not mainPart then return end

		-- Smart Search for Revenue Part
		local revenuePart = model:FindFirstChild("Revenue-indicator")
		
		-- Anchor Parts
		mainPart.Anchored = true
		mainPart.CanCollide = true 
		mainPart.Velocity = Vector3.zero

		if revenuePart then
			revenuePart.Anchored = true
			revenuePart.CanCollide = true 
			revenuePart.Velocity = Vector3.zero
		end

		-- 2. GET GUIS
		local avatarGui = mainPart:WaitForChild("AvatarGUI", 10)
		local usernameGui = mainPart:WaitForChild("UsernameGUI", 10)
		local claimGui = mainPart:WaitForChild("ClaimGUI", 10)
		
		-- Find RevenueGUI (Look in new part first, then old)
		local revenueGui = nil
		if revenuePart then revenueGui = revenuePart:FindFirstChild("RevenueGUI") end
		if not revenueGui then revenueGui = mainPart:FindFirstChild("RevenueGUI") end

		if not (avatarGui and usernameGui and claimGui and revenueGui) then return end

		-- 3. GET LABELS
		local avatarLabel = avatarGui:WaitForChild("Avatar-Label")
		local revenueLabel = revenueGui:WaitForChild("Total-Revenue")
		local usernameLabel = usernameGui:WaitForChild("Username")

		local ownerVal = plot:WaitForChild("Owner", 10)
		local pendingVal = plot:WaitForChild("PendingEarnings", 10)
		
		-- üîß AUTO-FIX: SEPARATE "$" FROM NUMBER üîß
		-- This logic creates a stagnant "$" label if it doesn't exist yet.
		if revenueLabel:IsA("TextLabel") then
			
			-- Check if we already created the Dollar Label
			local dollarLabel = revenueGui:FindFirstChild("Dollar-Static")
			
			if not dollarLabel then
				-- CLONE the original label to keep your FONT and STYLE exactly the same
				dollarLabel = revenueLabel:Clone()
				dollarLabel.Name = "Dollar-Static"
				dollarLabel.Parent = revenueGui
				
				-- CONFIG 1: The Dollar Sign (Static on the Left)
				dollarLabel.Text = "$"
				dollarLabel.Size = UDim2.new(0.25, 0, 1, 0) -- Takes up 25% of space on left
				dollarLabel.Position = UDim2.new(0, 0, 0, 0) -- Far left
				dollarLabel.TextXAlignment = Enum.TextXAlignment.Center -- Center the $ in its own box
				
				-- CONFIG 2: The Number (Dynamic on the Right)
				revenueLabel.Size = UDim2.new(0.75, 0, 1, 0) -- Takes up remaining 75%
				revenueLabel.Position = UDim2.new(0.25, 0, 0, 0) -- Starts after the $
				revenueLabel.TextXAlignment = Enum.TextXAlignment.Left -- Grows to the right
			end
		end

		-- 4. UPDATE FUNCTIONS
		local function updateOwnerInfo()
			local playerName = ownerVal.Value
			if playerName and playerName ~= "" then
				usernameLabel.Text = playerName
				local success, userId = pcall(function() return Players:GetUserIdFromNameAsync(playerName) end)
				if success and userId then
					local content, isReady = Players:GetUserThumbnailAsync(userId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size420x420)
					avatarLabel.Image = isReady and content or ""
				else
					avatarLabel.Image = "" 
				end
			else
				usernameLabel.Text = "Vacant"
				avatarLabel.Image = "" 
			end
		end

		local function updateRevenue()
			-- ONLY update the number (The $ is now handled by the separate label)
			revenueLabel.Text = formatNumber(pendingVal.Value) 
		end

		-- 5. LISTENERS
		ownerVal.Changed:Connect(updateOwnerInfo)
		pendingVal.Changed:Connect(updateRevenue)

		updateOwnerInfo()
		updateRevenue()
	end)
end

-- Initialize Existing Tycoons
for _, plot in pairs(TycoonFolder:GetChildren()) do
	setupTablet(plot)
end
TycoonFolder.ChildAdded:Connect(setupTablet)

-- ============================================================================
-- üì° REMOTE HANDLING
-- ============================================================================
TabletEvent.OnServerEvent:Connect(function(player, action, plotName)
	local plot = TycoonFolder:FindFirstChild(plotName)
	if not plot then return end

	if plot.Owner.Value ~= player.Name then return end
	local pendingVal = plot:FindFirstChild("PendingEarnings")
	if not pendingVal then return end

	if action == "Claim" then
		local amount = pendingVal.Value
		if amount <= 0 then return end 
		pendingVal.Value = 0 
		local ls = player:FindFirstChild("leaderstats")
		if ls and ls:FindFirstChild("Cash") then ls.Cash.Value += amount end

	elseif action == "Prompt2X" then
		local amount = pendingVal.Value
		if amount <= 0 then return end 
		MarketplaceService:PromptProductPurchase(player, DEV_PRODUCT_ID)
	end
end)

-- ============================================================================
-- üí∞ DEV PRODUCT PROCESSOR
-- ============================================================================
MarketplaceService.ProcessReceipt = function(receiptInfo)
	if receiptInfo.ProductId == DEV_PRODUCT_ID then
		local player = Players:GetPlayerByUserId(receiptInfo.PlayerId)
		if not player then return Enum.ProductPurchaseDecision.PurchaseGranted end

		local myPlotName = player:GetAttribute("OccupiedPlot")
		local plot = TycoonFolder:FindFirstChild(myPlotName or "")

		if plot and plot:FindFirstChild("PendingEarnings") then
			local pendingVal = plot.PendingEarnings
			local amount = pendingVal.Value
			if amount > 0 then
				pendingVal.Value = 0
				local ls = player:FindFirstChild("leaderstats")
				if ls and ls:FindFirstChild("Cash") then ls.Cash.Value += (amount * 2) end
			end
			return Enum.ProductPurchaseDecision.PurchaseGranted
		end
	end
	return Enum.ProductPurchaseDecision.NotProcessedYet
end
