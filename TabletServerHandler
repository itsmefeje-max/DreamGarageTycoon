-- [[ SERVER SCRIPT: TabletServerHandler (Secure & Fixed) ]]
-- Handles Tablet Owner Info, Secure Claiming, Cooldowns, SFX.
-- NOTE: DevProduct receipt handling is now centralized in ReceiptRouter.

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local MarketplaceService = game:GetService("MarketplaceService")
local Debris = game:GetService("Debris")

-- ‚öôÔ∏è CONFIGURATION
local DEV_PRODUCT_ID = 3509697462
local TYCOON_FOLDER_NAME = "Tycoons"
local CLAIM_COOLDOWN = 1.5
local MAX_CLAIM_DISTANCE = 20

-- üîä SOUND CONFIGURATION
local SUCCESS_SOUND = "rbxassetid://140072726814802"
local FAIL_SOUND = "rbxassetid://3779045779"

-- üìÇ REFERENCES
local TycoonFolder = Workspace:WaitForChild(TYCOON_FOLDER_NAME)
local TabletEvent = ReplicatedStorage:FindFirstChild("TabletEvent")

if not TabletEvent then
	TabletEvent = Instance.new("RemoteEvent")
	TabletEvent.Name = "TabletEvent"
	TabletEvent.Parent = ReplicatedStorage
end

-- üõ°Ô∏è STATE MANAGEMENT
local playerCooldowns = {}

-- üìä NUMBER FORMATTER
local SUFFIXES = {"K","M","B","T","Qa","Qi","Sx","Sp","Oc","No","Dc"}
local function formatNumber(n)
	n = tonumber(n) or 0
	if n < 1000 then return tostring(math.floor(n)) end
	local i = math.floor(math.log(n, 1000))
	return string.format("%.2f%s", n / (1000^i), SUFFIXES[i] or "?")
end

-- üßπ CLEAN UI CONSTRAINTS
local function nukeConstraints(obj)
	for _, child in pairs(obj:GetChildren()) do
		if child:IsA("UITextSizeConstraint") then
			child:Destroy()
		end
	end
end

-- üîä PLAY SOUND
local function playSound(part, soundId, volume)
	local sound = Instance.new("Sound")
	sound.SoundId = soundId
	sound.Volume = volume or 1
	sound.RollOffMaxDistance = 50
	sound.Parent = part
	sound:Play()
	Debris:AddItem(sound, 2)
end

-- =====================================================================
-- üõ†Ô∏è TABLET SETUP (VISUALS)
-- =====================================================================
local function setupTablet(plot)
	task.spawn(function()
		local model = plot:WaitForChild("ClaimEarnings", 30)
		if not model then return end

		local mainPart = model:WaitForChild("Earnings", 10)
		local claimPart = model:WaitForChild("ClaimPart", 10)
		if not (mainPart and claimPart) then return end

		mainPart.Anchored = true
		claimPart.Anchored = true

		local ownerVal = plot:WaitForChild("Owner", 10)
		local pendingVal = plot:WaitForChild("PendingEarnings", 10)

		local usernameGui = mainPart:FindFirstChild("UsernameGUI")
		local revenueGui = mainPart:FindFirstChild("RevenueGUI")
		if not (usernameGui and revenueGui) then return end

		local usernameLabel = usernameGui:FindFirstChild("Username")
		local revenueLabel = revenueGui:FindFirstChild("Total-Revenue")
		if not (usernameLabel and revenueLabel) then return end

		nukeConstraints(usernameLabel)
		nukeConstraints(revenueLabel)

		ownerVal.Changed:Connect(function()
			usernameLabel.Text = ownerVal.Value ~= "" and ownerVal.Value or "Vacant"
		end)

		pendingVal.Changed:Connect(function()
			revenueLabel.Text = formatNumber(pendingVal.Value)
		end)

		usernameLabel.Text = ownerVal.Value ~= "" and ownerVal.Value or "Vacant"
		revenueLabel.Text = formatNumber(pendingVal.Value)
	end)
end

for _, plot in ipairs(TycoonFolder:GetChildren()) do
	setupTablet(plot)
end
TycoonFolder.ChildAdded:Connect(setupTablet)

-- =====================================================================
-- üì° CLAIM & PROMPT HANDLING
-- =====================================================================
TabletEvent.OnServerEvent:Connect(function(player, action, plotName)
	local plot = TycoonFolder:FindFirstChild(plotName)
	if not plot or plot.Owner.Value ~= player.Name then return end

	local pendingVal = plot:FindFirstChild("PendingEarnings")
	local model = plot:FindFirstChild("ClaimEarnings")
	local claimPart = model and model:FindFirstChild("ClaimPart")
	if not (pendingVal and claimPart) then return end

	if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
	if (player.Character.HumanoidRootPart.Position - claimPart.Position).Magnitude > MAX_CLAIM_DISTANCE then return end

	if action == "Claim" then
		local last = playerCooldowns[player.UserId] or 0
		if os.clock() - last < CLAIM_COOLDOWN then return end

		if pendingVal.Value > 0 then
			local amount = pendingVal.Value
			pendingVal.Value = 0
			player.leaderstats.Cash.Value += amount
			playSound(claimPart, SUCCESS_SOUND)
		else
			playSound(claimPart, FAIL_SOUND)
		end

		playerCooldowns[player.UserId] = os.clock()

	elseif action == "Prompt2X" then
		if pendingVal.Value > 0 then
			MarketplaceService:PromptProductPurchase(player, DEV_PRODUCT_ID)
		end
	end
end)

-- =====================================================================
-- ‚ùå DEV PRODUCT RECEIPT HANDLER (DISABLED)
-- =====================================================================
-- IMPORTANT:
-- MarketplaceService.ProcessReceipt is now handled by
-- ServerScriptService > ReceiptRouter
-- DO NOT re-enable this here or it will conflict.

--[[
MarketplaceService.ProcessReceipt = function(receiptInfo)
	-- OLD TABLET 2X LOGIC (MOVED TO ReceiptRouter)
	return Enum.ProductPurchaseDecision.NotProcessedYet
end
]]
