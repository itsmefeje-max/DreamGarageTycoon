-- [[ SERVER SCRIPT: PadSkinManager (INSTANT FIX) ]]
-- Purpose: Visual Handler. Paints Gold, and FORCE RESTORES default if stuck.
-- Location: ServerScriptService

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local TycoonFolder = Workspace:WaitForChild("Tycoons")
local BaseSkinStats = require(ReplicatedStorage:WaitForChild("BaseSkinStats"))

-- ============================================================================
-- ðŸŽ¨ CONFIGURATION (THE "NORMAL" LOOK)
-- Change these if your pads are not Grey/Plastic!
-- ============================================================================
local DEFAULT_COLOR = Color3.fromRGB(163, 162, 165) -- Standard Medium Stone Grey
local DEFAULT_MATERIAL = Enum.Material.Plastic
local DEFAULT_REFLECTANCE = 0

-- ðŸ›‘ EXCLUSION CHECK
local function IsIgnored(part)
	if part.Name == "BuyButton" then return true end
	if part.Parent and part.Parent.Name == "BuyButton" then return true end
	if part.Name == "Price" or part.Name == "PriceLabel" then return true end
	if part.Transparency >= 1 then return true end 
	return false
end

-- ðŸ’¾ SAVE STATE (With Safety Check)
local function EnsureOriginalStateSaved(part)
	if part:GetAttribute("Skin_OrigColor") then return end -- Already saved

	-- CHECK: Is it ALREADY Gold? (The Bug)
	-- If it is Gold/Neon, DO NOT save this as the "Original". It's wrong!
	local isSuspectGold = (part.Material == Enum.Material.Metal or part.Material == Enum.Material.Neon) 
		and (part.Color == Color3.fromRGB(255, 215, 0) or part.Color == Color3.fromRGB(255, 255, 0))

	if isSuspectGold then
		-- It's bugged. We don't save this. We will rely on the DEFAULT constants above.
		return
	end

	-- It looks normal, so save it!
	part:SetAttribute("Skin_OrigColor", part.Color)
	part:SetAttribute("Skin_OrigMat", part.Material.Name)
	part:SetAttribute("Skin_OrigRef", part.Reflectance)
end

-- ðŸŽ¨ THE PAINT ENGINE
local function PaintPlot(plot, skinName)
	if not plot then return end

	local skinData = BaseSkinStats[skinName]
	local isDefault = (skinName == "Default" or skinName == nil)

	if not isDefault and not skinData then return end

	local padsFolder = plot:FindFirstChild("Pads")
	if not padsFolder then return end

	print("ðŸŽ¨ Updating " .. plot.Name .. " to " .. (skinName or "Default"))

	for _, padModel in pairs(padsFolder:GetChildren()) do

		-- 1. GATHER PARTS
		local partsToPaint = {}
		if padModel:IsA("BasePart") and not IsIgnored(padModel) then
			table.insert(partsToPaint, padModel)
		end
		for _, part in pairs(padModel:GetDescendants()) do
			if part:IsA("BasePart") and not IsIgnored(part) then
				table.insert(partsToPaint, part)
			end
		end

		-- 2. TRY TO SAVE ORIGINALS (Will skip if currently Gold/Bugged)
		for _, part in ipairs(partsToPaint) do
			EnsureOriginalStateSaved(part)
		end

		-- 3. APPLY OR RESTORE
		if isDefault then
			-- ðŸ”™ RESTORE MODE
			for _, part in ipairs(partsToPaint) do
				local origColor = part:GetAttribute("Skin_OrigColor")
				local origMat = part:GetAttribute("Skin_OrigMat")
				local origRef = part:GetAttribute("Skin_OrigRef")

				if origColor and origMat then
					-- âœ… CASE A: We have memory. Restore exactly.
					part.Color = origColor
					part.Material = Enum.Material[origMat]
					part.Reflectance = origRef or 0
				else
					-- âš ï¸ CASE B: No memory (It was stuck Gold). FORCE FIX using Defaults.
					part.Color = DEFAULT_COLOR
					part.Material = DEFAULT_MATERIAL
					part.Reflectance = DEFAULT_REFLECTANCE
				end
			end
		else
			-- âœ¨ GOLD MODE
			table.sort(partsToPaint, function(a, b)
				local volA = a.Size.X * a.Size.Y * a.Size.Z
				local volB = b.Size.X * b.Size.Y * b.Size.Z
				return volA > volB 
			end)

			for i, part in ipairs(partsToPaint) do
				part.Color = skinData.Color
				if i == 1 then
					part.Material = Enum.Material.Metal
					part.Reflectance = 0.4
				else
					part.Material = Enum.Material.Neon
					part.Reflectance = 0
				end
			end
		end
	end
end

-- ðŸ”„ PLAYER MONITOR
local function SetupPlayer(player)
	task.spawn(function()
		local plotName = player:GetAttribute("OccupiedPlot")
		while not plotName do
			player:GetAttributeChangedSignal("OccupiedPlot"):Wait()
			plotName = player:GetAttribute("OccupiedPlot")
		end

		local plot = TycoonFolder:WaitForChild(plotName, 10)
		if not plot then return end

		-- Check State immediately to fix any stuck pads
		local currentSkin = player:GetAttribute("EquippedSkin") or "Default"
		PaintPlot(plot, currentSkin)

		-- Live Listener
		player:GetAttributeChangedSignal("EquippedSkin"):Connect(function()
			local newSkin = player:GetAttribute("EquippedSkin")
			PaintPlot(plot, newSkin)
		end)
	end)
end

Players.PlayerAdded:Connect(SetupPlayer)
for _, p in pairs(Players:GetPlayers()) do SetupPlayer(p) end

-- ðŸš‘ EMERGENCY CLEANUP ON STARTUP
-- Use this loop to catch any players already in-game when you update the script
for _, p in pairs(Players:GetPlayers()) do
	SetupPlayer(p)
end
