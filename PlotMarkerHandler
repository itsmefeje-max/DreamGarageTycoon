-- [[ LOCAL SCRIPT: PlotMarkerHandler (Universal V4 - Robust Edition) ]]
-- -- Indicating what the script is for: Attaches "YOUR PLOT" marker to a universal part (Guaranteed Fix).
-- FEATURES: Uses Smart-Waiting to ensure it works even if the plot loads slowly.

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local TycoonFolder = Workspace:WaitForChild("Tycoons")

-- ============================================================================
-- ‚öôÔ∏è CONFIGURATION
-- ============================================================================
local INDICATOR_TEMPLATE_NAME = "YourPlotIndicator" -- Name of GUI in ReplicatedStorage
local HEIGHT_OFFSET = 12      -- Studs above the part (High enough to be seen)
local ANIMATE_BOUNCE = true   -- Bobbing animation
local BOUNCE_SPEED = 2
local BOUNCE_HEIGHT = 1.5

-- üéØ TARGET PATHS (Priority List)
-- The script will wait for #1. If it times out, it tries #2, etc.
local TARGET_PATHS = {
	{ "NormalGarage", "Garage Parts", "OwnerIndicator" },   -- ü•á Your requested universal part
	{ "NormalGarage", "GarageInformation", "OwnerLabel" },  -- ü•à Old fallback
	{ "SpawnPoint" }                                        -- ü•â Last resort (Always exists)
}

-- ============================================================================
-- üõ†Ô∏è LOGIC
-- ============================================================================
local currentIndicator = nil
local bounceConnection = nil
local isSearching = false -- Prevents overlapping searches

-- Helper to safely find a nested part with PATIENCE
local function findPartByPath(root, pathArray)
	local current = root
	for _, name in ipairs(pathArray) do
		-- üõ°Ô∏è CRITICAL FIX: Use WaitForChild with a timeout (2s)
		-- This gives the game time to load the part if it's streaming in.
		current = current:WaitForChild(name, 2)
		if not current then return nil end
	end
	return current
end

local function cleanup()
	if currentIndicator then currentIndicator:Destroy() currentIndicator = nil end
	if bounceConnection then bounceConnection:Disconnect() bounceConnection = nil end
end

local function updateMarker()
	-- Prevent double-running
	if isSearching then return end
	isSearching = true

	cleanup() -- Reset first

	-- 1. Get Assigned Plot
	local myPlotName = player:GetAttribute("OccupiedPlot")
	if not myPlotName then 
		isSearching = false
		return 
	end

	local plot = TycoonFolder:FindFirstChild(myPlotName)
	if not plot then 
		-- Plot might not be loaded yet, retry in 1s
		isSearching = false
		task.wait(1)
		updateMarker()
		return 
	end

	-- 2. Find Best Target Part (With Waiting)
	local attachPart = nil

	for i, path in ipairs(TARGET_PATHS) do
		attachPart = findPartByPath(plot, path)
		if attachPart then 
			print("üìç PlotMarker: Found target via Path #" .. i .. " (" .. attachPart.Name .. ")")
			break 
		end
	end

	-- 3. Create Marker
	if attachPart then
		local template = ReplicatedStorage:FindFirstChild(INDICATOR_TEMPLATE_NAME)
		if not template then 
			warn("‚ö†Ô∏è PlotMarker: Missing '"..INDICATOR_TEMPLATE_NAME.."' in ReplicatedStorage!") 
			isSearching = false
			return 
		end

		currentIndicator = template:Clone()
		currentIndicator.Parent = player.PlayerGui
		currentIndicator.Adornee = attachPart

		-- Ensure it's always on top if needed
		if currentIndicator:IsA("BillboardGui") then
			currentIndicator.AlwaysOnTop = true
		end

		-- Set Initial Height
		local currentOffset = currentIndicator.StudsOffset
		currentIndicator.StudsOffset = Vector3.new(currentOffset.X, HEIGHT_OFFSET, currentOffset.Z)

		currentIndicator.Enabled = true

		-- 4. Bounce Animation
		if ANIMATE_BOUNCE then
			local t = 0
			bounceConnection = RunService.RenderStepped:Connect(function(dt)
				if not currentIndicator or not currentIndicator.Adornee then cleanup() return end
				t = t + dt * BOUNCE_SPEED
				local bounce = math.sin(t) * BOUNCE_HEIGHT
				currentIndicator.StudsOffset = Vector3.new(currentOffset.X, HEIGHT_OFFSET + bounce, currentOffset.Z)
			end)
		end
	else
		-- ‚ö†Ô∏è STILL NOT FOUND? RETRY.
		-- This happens if the Garage hasn't been built/loaded yet.
		-- We keep trying every 2 seconds until it appears.
		print("‚è≥ PlotMarker: Target part not found yet. Retrying...")
		task.delay(2, function()
			isSearching = false
			updateMarker()
		end)
		return -- Exit so we don't set isSearching=false immediately
	end

	isSearching = false
end

-- üîÑ AUTO-UPDATE
player:GetAttributeChangedSignal("OccupiedPlot"):Connect(updateMarker)

-- Startup Check
task.wait(2) 
updateMarker()
