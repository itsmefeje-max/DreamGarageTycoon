-- -- Indicating what the script is for: Handles Camera, Logic, and UI for AfraiC4t ATM.
-- UPDATES: 
-- 1. FIXED: Added Recursive Search (true) for buttons. It now finds buttons even if they are nested in folders.
-- 2. FIXED: Added explicit debug warnings if a button ID is spelled wrong or missing.
-- 3. OPTIMIZED: Better connection cleanup to prevent memory leaks.
-- LOCATION: StarterPlayer > StarterPlayerScripts

local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local SoundService = game:GetService("SoundService")

local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera
local playerGui = player:WaitForChild("PlayerGui")

-- ============================================================================
-- üÜî UNIQUE IDENTIFIERS (Must match your GUI Properties EXACTLY)
-- ============================================================================
local GUI_ID = "UI_NPC_ATM_AfraiC4t"       -- The Name of the ScreenGui
local CONTAINER_ID = "Frame_ATM_Container" -- The Main Background Frame
local TEXT_ID = "Text_ATM_Dialogue"        -- The TextLabel for talking
local BTN_WITHDRAW_ID = "Btn_ATM_Withdraw" -- Name of Withdraw Button
local BTN_INQUIRY_ID = "Btn_ATM_Inquiry"   -- Name of Inquiry Button
local BTN_LEAVE_ID = "Btn_ATM_Leave"       -- Name of Leave Button

-- üìç NPC CONFIGURATION
local NPC_FOLDER = "NPCS"
local TARGET_NPC = "AfraiC4t"
local CAMERA_PART = "CameraAimPart"
local PROMPT_NAME = "TalkPrompt" 

-- üé• SETTINGS
local TWEEN_INFO = TweenInfo.new(0.8, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
local TYPEWRITER_SPEED = 0.02

-- üîä SOUNDS
local TYPING_SOUND_ID = "rbxassetid://4676738150"

-- üí¨ RANDOM GREETINGS
local GREETING_OPTIONS = {
	"Welcome back, [Name]. My systems are ready.",
	"Greetings. The ATM secure channel is open.",
	"Hello, [Name]. Proceed with your transaction.",
	"System Online. Awaiting input.",
	"Good day, [Name]. Banking services are operational."
}

-- ============================================================================
-- üõ†Ô∏è STATE VARIABLES
-- ============================================================================
local isInteracting = false
local currentDialogueJob = nil 
local buttonConnections = {} -- Store connections here to clean them up properly
local controls = require(player.PlayerScripts:WaitForChild("PlayerModule")):GetControls()

-- Ensure Event Exists
local OpenATMEvent = ReplicatedStorage:FindFirstChild("OpenATMEvent")
if not OpenATMEvent then
	OpenATMEvent = Instance.new("BindableEvent")
	OpenATMEvent.Name = "OpenATMEvent"
	OpenATMEvent.Parent = ReplicatedStorage
end

-- ============================================================================
-- üé¨ INTERACTION FUNCTIONS
-- ============================================================================

-- Helper to clear old button clicks to prevent double-clicking bugs
local function clearConnections()
	for _, conn in pairs(buttonConnections) do
		if conn then conn:Disconnect() end
	end
	buttonConnections = {}
end

-- Typewriter effect logic
local function typewrite(label, text)
	if not label then return end
	
	-- Stop previous typing task if it's running
	if currentDialogueJob then 
		task.cancel(currentDialogueJob) 
		currentDialogueJob = nil 
	end

	label.Text = "" -- Clear text immediately
	
	currentDialogueJob = task.spawn(function()
		for i = 1, #text do
			if not isInteracting then break end
			label.Text = string.sub(text, 1, i)
			
			-- Sound effect (every 3 letters to not be annoying)
			if i % 3 == 0 then 
				local s = Instance.new("Sound", SoundService)
				s.SoundId = TYPING_SOUND_ID
				s.Volume = 0.1
				s.PlayOnRemove = true
				s:Destroy()
			end
			
			task.wait(TYPEWRITER_SPEED)
		end
	end)
end

-- Close the menu and reset everything
local function stopInteraction()
	if not isInteracting then return end
	print("üõë Closing Interaction...")
	isInteracting = false
	
	-- Stop typing
	if currentDialogueJob then task.cancel(currentDialogueJob) end
	
	clearConnections() -- Clean up buttons

	-- 1. Restore Camera & Controls
	camera.CameraType = Enum.CameraType.Custom
	if controls then controls:Enable() end
	
	if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
		player.Character.HumanoidRootPart.Anchored = false
	end

	-- 2. Hide UI
	local myGui = playerGui:FindFirstChild(GUI_ID)
	if myGui then
		myGui.Enabled = false
		local container = myGui:FindFirstChild(CONTAINER_ID)
		if container then container.Visible = false end
	end
end

-- Start the interaction
local function startInteraction(npcModel)
	if isInteracting then return end
	isInteracting = true
	clearConnections() -- Safety clear

	-- Check for Camera Part
	local camPart = npcModel:FindFirstChild(CAMERA_PART)
	if not camPart then
		warn("‚ùå Error: Missing '"..CAMERA_PART.."' inside " .. npcModel.Name)
		isInteracting = false
		return
	end

	-- Freeze Player
	if controls then controls:Disable() end
	if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
		player.Character.HumanoidRootPart.Anchored = true 
	end

	-- Move Camera
	camera.CameraType = Enum.CameraType.Scriptable
	TweenService:Create(camera, TWEEN_INFO, {CFrame = camPart.CFrame}):Play()

	-- Get UI
	local myGui = playerGui:WaitForChild(GUI_ID, 5)
	if not myGui then warn("‚ùå Missing GUI: " .. GUI_ID) stopInteraction() return end
	
	-- Show UI
	myGui.Enabled = true
	
	-- We search for container recursively in case you moved it
	local container = myGui:FindFirstChild(CONTAINER_ID, true) 
	if not container then warn("‚ùå Missing Frame: " .. CONTAINER_ID) stopInteraction() return end
	
	container.Visible = true 

	-- Play Initial Greeting
	local dialogueLabel = container:FindFirstChild(TEXT_ID, true) -- Recursive find
	if dialogueLabel then
		local greeting = GREETING_OPTIONS[math.random(1, #GREETING_OPTIONS)]
		greeting = greeting:gsub("%[Name%]", player.Name)
		typewrite(dialogueLabel, greeting)
	else
		warn("‚ö†Ô∏è Dialogue Label '"..TEXT_ID.."' not found in Container.")
	end

	-- ==============================
	-- üîò BUTTON SETUP (FIXED LOGIC)
	-- ==============================
	
	-- Helper to Connect Buttons securely
	local function connectBtn(btnName, func)
		-- FIX: recursive search (true) allows button to be anywhere inside the GUI
		local btn = myGui:FindFirstChild(btnName, true) 
		
		if btn and btn:IsA("GuiButton") then
			-- Store connection
			local conn = btn.MouseButton1Click:Connect(func)
			table.insert(buttonConnections, conn)
			-- print("‚úÖ Connected Button: " .. btnName) -- Uncomment for debugging
		else
			warn("‚ùå BUTTON ERROR: Could not find button named '" .. btnName .. "' inside " .. GUI_ID)
		end
	end

	-- 1. LEAVE BUTTON
	connectBtn(BTN_LEAVE_ID, function()
		stopInteraction()
	end)

	-- 2. INQUIRY BUTTON
	connectBtn(BTN_INQUIRY_ID, function()
		print("‚ÑπÔ∏è Inquiry Clicked")
		if dialogueLabel then
			local guide = "BANKING GUIDE:\n\n1. EARN: Your Plot generates income.\n2. WITHDRAW: Move earnings to Wallet.\n3. SPEND: Use Cash for upgrades."
			typewrite(dialogueLabel, guide)
		end
	end)

	-- 3. WITHDRAW BUTTON
	connectBtn(BTN_WITHDRAW_ID, function()
		if dialogueLabel then
			typewrite(dialogueLabel, "Accessing Secure Vault...")
			task.wait(0.5)
		end
		stopInteraction()
		OpenATMEvent:Fire()
	end)
end

-- ============================================================================
-- ‚ö° SETUP (Deep Search)
-- ============================================================================
local function setupATM()
	local folder = Workspace:WaitForChild(NPC_FOLDER)
	local npc = folder:WaitForChild(TARGET_NPC, 10)

	if npc then
		-- Search recursively for the prompt (Works in Attachments/Torso)
		local prompt = npc:FindFirstChild(PROMPT_NAME, true) 
		
		-- Retry if streaming (sometimes parts load slowly)
		local retries = 0
		while not prompt and retries < 10 do
			task.wait(0.5)
			prompt = npc:FindFirstChild(PROMPT_NAME, true)
			retries = retries + 1
		end

		if prompt then
			print("‚úÖ ATM Ready. Prompt found in: " .. prompt.Parent.Name)
			prompt.Triggered:Connect(function()
				startInteraction(npc)
			end)
		else
			warn("‚ö†Ô∏è CRITICAL: Could not find Prompt '"..PROMPT_NAME.."' inside " .. TARGET_NPC)
		end
	else
		warn("‚ùå Critical: NPC '"..TARGET_NPC.."' not found.")
	end
end

setupATM()
