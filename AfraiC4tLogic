-- [[ LOCAL SCRIPT: AfraiC4t_ATM_Controller ]]
-- -- Indicating what the script is for: Handles Camera & UI Logic EXCLUSIVELY for the ATM NPC (AfraiC4t).
-- LOCATION: StarterPlayer > StarterPlayerScripts

local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera
local playerGui = player:WaitForChild("PlayerGui")

-- ============================================================================
-- üÜî UNIQUE IDENTIFIERS (Must match your GUI exactly)
-- ============================================================================
local GUI_ID = "UI_NPC_ATM_AfraiC4t"          -- The specific ScreenGui for ATM
local CONTAINER_ID = "Frame_ATM_Container"    -- The Frame inside
local TEXT_ID = "Text_ATM_Dialogue"           -- The TextLabel inside
local BTN_WITHDRAW_ID = "Btn_ATM_Withdraw"    -- Button 1
local BTN_INQUIRY_ID = "Btn_ATM_Inquiry"      -- Button 2
local BTN_LEAVE_ID = "Btn_ATM_Leave"          -- Button 3

-- üìç NPC CONFIGURATION
local NPC_FOLDER = "NPCS"
local TARGET_NPC = "AfraiC4t"                 -- Specific NPC Name
local CAMERA_PART = "CameraAimPart"           -- Invisible part inside NPC
local PROMPT_NAME = "ProximityPrompt"

-- üé• CAMERA SETTINGS
local TWEEN_INFO = TweenInfo.new(1.2, Enum.EasingStyle.Exponential, Enum.EasingDirection.Out)
local BLUR_SIZE = 15

-- ============================================================================
-- üõ†Ô∏è STATE VARIABLES
-- ============================================================================
local isInteracting = false
local controls = require(player.PlayerScripts:WaitForChild("PlayerModule")):GetControls()
local blurEffect = Instance.new("BlurEffect", camera)
blurEffect.Size = 0
blurEffect.Enabled = false

-- üì° EVENT SIGNAL (The "Doorbell" for the Bank Script)
local OpenATMEvent = ReplicatedStorage:FindFirstChild("OpenATMEvent")
if not OpenATMEvent then
	OpenATMEvent = Instance.new("BindableEvent")
	OpenATMEvent.Name = "OpenATMEvent"
	OpenATMEvent.Parent = ReplicatedStorage
end

-- ============================================================================
-- üé¨ INTERACTION FUNCTIONS
-- ============================================================================

local function stopInteraction()
	if not isInteracting then return end
	
	-- 1. Close the Specific ATM GUI
	local myGui = playerGui:FindFirstChild(GUI_ID)
	if myGui then
		myGui.Enabled = false
	end

	-- 2. Reset Camera & Blur
	camera.CameraType = Enum.CameraType.Custom
	TweenService:Create(blurEffect, TWEEN_INFO, {Size = 0}):Play()
	
	-- 3. Unfreeze Player
	if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
		player.Character.HumanoidRootPart.Anchored = false
	end
	if controls then controls:Enable() end
	
	task.wait(0.5)
	blurEffect.Enabled = false
	isInteracting = false
end

local function startInteraction(npcModel)
	if isInteracting then return end
	isInteracting = true

	-- 1. Locate Camera Target
	local camPart = npcModel:FindFirstChild(CAMERA_PART)
	if not camPart then
		warn("‚ùå ATM Error: Missing '"..CAMERA_PART.."' inside " .. npcModel.Name)
		isInteracting = false
		return
	end

	-- 2. Freeze Player
	if controls then controls:Disable() end
	if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
		player.Character.HumanoidRootPart.Anchored = true 
	end

	-- 3. Cinematic Camera Move
	camera.CameraType = Enum.CameraType.Scriptable
	blurEffect.Enabled = true
	TweenService:Create(blurEffect, TWEEN_INFO, {Size = BLUR_SIZE}):Play()
	TweenService:Create(camera, TWEEN_INFO, {CFrame = camPart.CFrame}):Play()

	-- 4. ACTIVATE SPECIFIC ATM GUI
	local myGui = playerGui:WaitForChild(GUI_ID, 5)
	if not myGui then
		warn("‚ùå ATM Error: Could not find ScreenGui named '" .. GUI_ID .. "'")
		stopInteraction()
		return
	end

	local container = myGui:FindFirstChild(CONTAINER_ID)
	if not container then
		warn("‚ùå ATM Error: Could not find Frame named '" .. CONTAINER_ID .. "'")
		stopInteraction()
		return
	end

	-- Reset Text
	local dialogue = container:FindFirstChild(TEXT_ID)
	if dialogue then
		dialogue.Text = "Greetings. I handle the ATM withdrawals. How may I assist you?"
	end

	-- 5. CONNECT BUTTONS (Refresh connections safely)
	-- We clone buttons to strip old connections from previous interactions
	local function refreshButton(btnName)
		local btn = container:FindFirstChild(btnName)
		if btn then
			local newBtn = btn:Clone()
			newBtn.Parent = btn.Parent
			btn:Destroy()
			return newBtn
		end
		return nil
	end

	local btnWithdraw = refreshButton(BTN_WITHDRAW_ID)
	local btnInquiry = refreshButton(BTN_INQUIRY_ID)
	local btnLeave = refreshButton(BTN_LEAVE_ID)

	-- [[ LOGIC: WITHDRAW ]]
	if btnWithdraw then
		btnWithdraw.MouseButton1Click:Connect(function()
			print("üèß Choice: Withdraw Selected.")
			stopInteraction()    -- Close NPC Camera
			OpenATMEvent:Fire()  -- üîî RING THE BELL for Bank Script
		end)
	end

	-- [[ LOGIC: INQUIRY ]]
	if btnInquiry then
		btnInquiry.MouseButton1Click:Connect(function()
			if dialogue then
				dialogue.Text = "We offer secure transfers from your Tycoon balance directly to your wallet."
			end
		end)
	end

	-- [[ LOGIC: LEAVE ]]
	if btnLeave then
		btnLeave.MouseButton1Click:Connect(function()
			stopInteraction()
		end)
	end

	-- Finally, Show the UI
	myGui.Enabled = true
end

-- ============================================================================
-- ‚ö° INITIALIZATION
-- ============================================================================
local function setupATM()
	-- Strictly look in Workspace > NPCS > AfraiC4t
	local folder = Workspace:WaitForChild(NPC_FOLDER)
	local npc = folder:WaitForChild(TARGET_NPC, 10)

	if npc then
		local prompt = npc:FindFirstChild(PROMPT_NAME) or npc:FindFirstChildWhichIsA("ProximityPrompt", true)
		if prompt then
			print("‚úÖ ATM Controller: Connected to " .. TARGET_NPC)
			prompt.Triggered:Connect(function()
				startInteraction(npc)
			end)
		else
			warn("‚ö†Ô∏è ATM Warning: No ProximityPrompt found in " .. TARGET_NPC)
		end
	else
		warn("‚ùå ATM Error: Could not find NPC '" .. TARGET_NPC .. "' in " .. NPC_FOLDER)
	end
end

setupATM()
