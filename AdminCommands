-- Purpose: Server-side Admin Commands with secure currency/inventory management
-- Runs on: Server (ServerScriptService)
-- Location: ServerScriptService > AdminCommands
-- Dependencies: TycoonAdminAPI (for clearing data), CarTools, FlyClient
-- Public API: Chat commands (/give, /fly, /clearwallet, etc.)
-- Networking: Uses RemoteFunctions via TycoonAdminAPI for data wipes
-- Security: UserID whitelist, debounces, server-side validation, nil-safe checks
-- Performance: Caches tools, minimal loop usage
-- Notes: Assumes leaderstats names are "Cash" (Bank) and "Wallet"

local Players = game:GetService("Players")
local ServerStorage = game:GetService("ServerStorage")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

-- ‚öôÔ∏è CONFIGURATION
local CarTools = ServerStorage:WaitForChild("CarTools") 
local FlyScriptTemplate = ServerStorage:WaitForChild("FlyClient", 5) 

-- ‚ö†Ô∏è SECURITY: Add your UserID here
local ADMIN_USER_IDS = {
	[5512860740] = true, -- Your ID
}

local IS_STUDIO = RunService:IsStudio()
local MAX_INVENTORY_SIZE = 500
local CMD_DEBOUNCE = 0.5 

-- üõ°Ô∏è STATE
local AdminDebounces = {}
local ToolCache = nil
math.randomseed(os.time()) 

-- üîó API CONNECTION
local TycoonAdminAPI = ServerStorage:WaitForChild("TycoonAdminAPI", 10)

if IS_STUDIO then
	print("‚ö†Ô∏è [AdminCommands]: Studio Mode - Everyone is Admin!")
end

if not FlyScriptTemplate then
	warn("‚ùå CRITICAL: 'FlyClient' missing in ServerStorage!")
end

if not TycoonAdminAPI then
	warn("‚ùå CRITICAL: 'TycoonAdminAPI' missing! /clear command will fail.")
end

-- ============================================================================
-- üõ°Ô∏è HELPERS
-- ============================================================================

local function getCleanID(rawName)
	if not rawName then return "" end
	local lower = rawName:lower()
	if lower:sub(-5) == " item" then return lower:sub(1, -6) end
	return lower
end

local function getAllTools()
	if ToolCache then return ToolCache end
	local tools = {}
	for _, t in pairs(CarTools:GetChildren()) do
		if t:IsA("Tool") then table.insert(tools, t) end
	end
	ToolCache = tools
	return tools
end
CarTools.ChildAdded:Connect(function() ToolCache = nil end)
CarTools.ChildRemoved:Connect(function() ToolCache = nil end)

local function getOwnedSet(player)
	local set = {}
	local function scan(container)
		if not container then return end
		for _, t in pairs(container:GetChildren()) do
			if t:IsA("Tool") then 
				-- Use the Attribute ID if available, otherwise name
				local id = t:GetAttribute("ToolId") or t.Name
				set[getCleanID(id)] = true 
			end
		end
	end
	scan(player:FindFirstChild("Backpack"))
	scan(player:FindFirstChild("StarterGear"))
	if player.Character then scan(player.Character) end
	return set
end

local function tagIssued(tool, realID)
	if not tool then return end
	tool:SetAttribute("IssuedByServer", true)
	tool:SetAttribute("IssuedAt", os.time())
	tool:SetAttribute("IssuedId", HttpService:GenerateGUID(false)) 
	tool:SetAttribute("ToolId", realID) 
	tool.CanBeDropped = false
end

local function findTool(itemName)
	local target = getCleanID(itemName)
	for _, tool in pairs(CarTools:GetChildren()) do
		if tool:IsA("Tool") then
			local tID = getCleanID(tool.Name)
			if tID == target then return tool end
		end
	end
	return nil
end

local function getAmount(amountText)
	local amount = tonumber(amountText)
	if not amount or amount <= 0 or amount ~= amount then return nil end
	return math.floor(amount)
end

local function getTargets(speaker, selector)
	if not selector then return {} end
	selector = selector:lower()
	if selector == "@s" or selector == "me" then return {speaker} end
	if selector == "@a" or selector == "all" then return Players:GetPlayers() end
	if selector == "@r" or selector == "random" then
		local plrs = Players:GetPlayers()
		return #plrs > 0 and {plrs[math.random(1, #plrs)]} or {}
	end
	local candidates = Players:GetPlayers()
	for _, p in pairs(candidates) do 
		if p.Name:lower() == selector or p.DisplayName:lower() == selector then return {p} end
	end
	for _, p in pairs(candidates) do 
		if p.Name:lower():sub(1, #selector) == selector then return {p} end
	end
	return {}
end

-- ============================================================================
-- ‚ö° ACTIONS
-- ============================================================================

local function setFlight(player, shouldFly)
	if not player.Character then return end
	local old = player.Character:FindFirstChild("FlyClient")
	if old then
		player.Character:SetAttribute("ForceStopFly", true)
		task.wait(0.1)
		old:Destroy()
		player.Character:SetAttribute("ForceStopFly", nil)
	end

	if shouldFly and FlyScriptTemplate then
		local scriptClone = FlyScriptTemplate:Clone()
		scriptClone.Name = "FlyClient"
		scriptClone.Parent = player.Character
		scriptClone.Disabled = false
	end
end

local function giveItem(player, tool, cleanID, optionalOwnedSet)
	local backpack = player:WaitForChild("Backpack", 5)
	if not backpack then return false end

	-- Check duplicates
	if optionalOwnedSet then
		if optionalOwnedSet[cleanID] then return false end
	else
		local currentSet = getOwnedSet(player)
		if currentSet[cleanID] then return false end
	end

	local bpTool = tool:Clone()
	tagIssued(bpTool, tool.Name) 
	bpTool.Parent = backpack

	local sg = player:FindFirstChild("StarterGear")
	if sg then
		local sgTool = tool:Clone()
		tagIssued(sgTool, tool.Name)
		sgTool.Parent = sg
	end
	return true
end

local function addCurrency(player, statName, amount)
	local leaderstats = player:FindFirstChild("leaderstats")
	if not leaderstats then return false end
	local stat = leaderstats:FindFirstChild(statName)
	if not stat then return false end
	stat.Value = stat.Value + amount
	return true
end

-- ============================================================================
-- üí¨ CHAT HANDLER
-- ============================================================================

Players.PlayerAdded:Connect(function(player)
	player.Chatted:Connect(function(message)
		if not (IS_STUDIO or ADMIN_USER_IDS[player.UserId]) then return end

		local lastCmd = AdminDebounces[player.UserId] or 0
		if (os.clock() - lastCmd) < CMD_DEBOUNCE then return end
		AdminDebounces[player.UserId] = os.clock()

		if message:sub(1,1) ~= "/" then return end

		local args = message:split(" ")
		local command = args[1]:lower()

		-- [[ /give ]]
		if command == "/give" then
			local selector = args[2]
			local itemName = table.concat(args, " ", 3)
			if not selector or itemName == "" then return end

			local targets = getTargets(player, selector)
			if #targets == 0 then return end

			if itemName:lower() == "all" or itemName:lower() == "everything" then
				local allTools = getAllTools()
				for _, t in pairs(targets) do
					local ownedSet = getOwnedSet(t)
					for _, tool in pairs(allTools) do
						local id = getCleanID(tool.Name)
						if not ownedSet[id] then
							giveItem(t, tool, id, ownedSet)
							ownedSet[id] = true
						end
					end
					print("‚úÖ [Admin] Given ALL to " .. t.Name)
				end
				return
			end

			local tool = findTool(itemName)
			if tool then
				local cleanID = getCleanID(tool.Name)
				for _, t in pairs(targets) do
					if giveItem(t, tool, cleanID) then
						print("‚úÖ [Admin] Given " .. tool.Name .. " to " .. t.Name)
					else
						warn("‚ö†Ô∏è " .. t.Name .. " already has " .. tool.Name)
					end
				end
			end

		-- [[ /fly & /unfly ]]
		elseif command == "/fly" then
			local targets = getTargets(player, args[2])
			for _, t in pairs(targets) do setFlight(t, true) end

		elseif command == "/unfly" then
			local targets = getTargets(player, args[2])
			for _, t in pairs(targets) do setFlight(t, false) end

		-- [[ /givebank & /givewallet ]]
		elseif command == "/givebank" or command == "/givewallet" then
			local selector = args[2]
			local amount = getAmount(args[3])
			if not selector or not amount then return end

			local targets = getTargets(player, selector)
			if #targets == 0 then return end

			local statName = command == "/givebank" and "Cash" or "Wallet"
			for _, t in pairs(targets) do
				if addCurrency(t, statName, amount) then
					print(("üí∞ [Admin] Added %s to %s (%s)"):format(amount, t.Name, statName))
				else
					warn("‚ö†Ô∏è [Admin] Missing leaderstats for " .. t.Name)
				end
			end

		-- [[ /clearwallet & /clearbank ]]
		elseif command == "/clearwallet" or command == "/clearbank" then
			local selector = args[2]
			local amountArg = args[3] -- Can be "all" or a number
			
			if not selector then return end
			local targets = getTargets(player, selector)
			
			-- Map command to stat name: clearbank -> Cash, clearwallet -> Wallet
			local statName = command == "/clearbank" and "Cash" or "Wallet"
			
			for _, t in pairs(targets) do
				local leaderstats = t:FindFirstChild("leaderstats")
				if leaderstats then
					local stat = leaderstats:FindFirstChild(statName)
					if stat then
						-- If arg is empty or "all", clear entirely
						if not amountArg or amountArg:lower() == "all" or amountArg == "*" then
							stat.Value = 0
							print(("üí∏ [Admin] Cleared %s for %s"):format(statName, t.Name))
						else
							-- If arg is a number, subtract it safely
							local amt = tonumber(amountArg)
							if amt then
								local old = stat.Value
								stat.Value = math.max(0, stat.Value - amt)
								print(("üí∏ [Admin] Removed %s from %s's %s (New: %s)"):format(amt, t.Name, statName, stat.Value))
							else
								warn("‚ö†Ô∏è Invalid amount format. Use number or 'all'")
							end
						end
					end
				end
			end

		-- [[ /clear & /clearall - ITEM WIPE ]]
		elseif command == "/clear" or command == "/clearall" then
			local targets = getTargets(player, args[2])
			if TycoonAdminAPI then
				for _, t in pairs(targets) do
					TycoonAdminAPI:Invoke("ForceWipe", t)
					print("üóëÔ∏è SECURE CLEAR: " .. t.Name)
				end
			else
				warn("‚ùå Cannot clear: API Missing")
			end
		end
	end)
end)
