-- [[ SERVER SCRIPT: AdminCommands (V10 - Secure Sync) ]]
-- FEATURES: Syncs with TycoonDataHandler to bypass Anti-Wipe protection.
-- LOCATION: ServerScriptService > Script

local Players = game:GetService("Players")
local ServerStorage = game:GetService("ServerStorage")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

-- âš™ï¸ CONFIGURATION
local CarTools = ServerStorage:WaitForChild("CarTools") 
local FlyScriptTemplate = ServerStorage:WaitForChild("FlyClient", 5) 

-- âš ï¸ SECURITY: Add your UserID here
local ADMIN_USER_IDS = {
	[5512860740] = true, -- Your ID
}

local IS_STUDIO = RunService:IsStudio()
local MAX_INVENTORY_SIZE = 500
local CMD_DEBOUNCE = 0.5 

-- ðŸ›¡ï¸ STATE
local AdminDebounces = {}
local ToolCache = nil
math.randomseed(os.time()) 

-- ðŸ”— API CONNECTION
local TycoonAdminAPI = ServerStorage:WaitForChild("TycoonAdminAPI", 10)

if IS_STUDIO then
	print("âš ï¸ [AdminCommands]: Studio Mode - Everyone is Admin!")
end

if not FlyScriptTemplate then
	warn("âŒ CRITICAL: 'FlyClient' missing in ServerStorage!")
end

if not TycoonAdminAPI then
	warn("âŒ CRITICAL: 'TycoonAdminAPI' missing! /clear command will fail.")
end

-- ============================================================================
-- ðŸ›¡ï¸ HELPERS
-- ============================================================================

local function getCleanID(rawName)
	if not rawName then return "" end
	local lower = rawName:lower()
	if lower:sub(-5) == " item" then return lower:sub(1, -6) end
	return lower
end

local function getAllTools()
	if ToolCache then return ToolCache end
	local tools = {}
	for _, t in pairs(CarTools:GetChildren()) do
		if t:IsA("Tool") then table.insert(tools, t) end
	end
	ToolCache = tools
	return tools
end
CarTools.ChildAdded:Connect(function() ToolCache = nil end)
CarTools.ChildRemoved:Connect(function() ToolCache = nil end)

local function getOwnedSet(player)
	local set = {}
	local function scan(container)
		if not container then return end
		for _, t in pairs(container:GetChildren()) do
			if t:IsA("Tool") then 
				-- Use the Attribute ID if available, otherwise name
				local id = t:GetAttribute("ToolId") or t.Name
				set[getCleanID(id)] = true 
			end
		end
	end
	scan(player:FindFirstChild("Backpack"))
	scan(player:FindFirstChild("StarterGear"))
	if player.Character then scan(player.Character) end
	return set
end

local function tagIssued(tool, realID)
	if not tool then return end
	tool:SetAttribute("IssuedByServer", true)
	tool:SetAttribute("IssuedAt", os.time())
	tool:SetAttribute("IssuedId", HttpService:GenerateGUID(false)) 
	tool:SetAttribute("ToolId", realID) 
	tool.CanBeDropped = false
end

local function findTool(itemName)
	local target = getCleanID(itemName)
	for _, tool in pairs(CarTools:GetChildren()) do
		if tool:IsA("Tool") then
			local tID = getCleanID(tool.Name)
			if tID == target then return tool end
		end
	end
	return nil
end

local function getTargets(speaker, selector)
	if not selector then return {} end
	selector = selector:lower()
	if selector == "@s" or selector == "me" then return {speaker} end
	if selector == "@a" or selector == "all" then return Players:GetPlayers() end
	if selector == "@r" or selector == "random" then
		local plrs = Players:GetPlayers()
		return #plrs > 0 and {plrs[math.random(1, #plrs)]} or {}
	end
	local candidates = Players:GetPlayers()
	for _, p in pairs(candidates) do 
		if p.Name:lower() == selector or p.DisplayName:lower() == selector then return {p} end
	end
	for _, p in pairs(candidates) do 
		if p.Name:lower():sub(1, #selector) == selector then return {p} end
	end
	return {}
end

-- ============================================================================
-- âš¡ ACTIONS
-- ============================================================================

local function setFlight(player, shouldFly)
	if not player.Character then return end
	local old = player.Character:FindFirstChild("FlyClient")
	if old then
		player.Character:SetAttribute("ForceStopFly", true)
		task.wait(0.1)
		old:Destroy()
		player.Character:SetAttribute("ForceStopFly", nil)
	end

	if shouldFly and FlyScriptTemplate then
		local scriptClone = FlyScriptTemplate:Clone()
		scriptClone.Name = "FlyClient"
		scriptClone.Parent = player.Character
		scriptClone.Disabled = false
	end
end

local function giveItem(player, tool, cleanID, optionalOwnedSet)
	local backpack = player:WaitForChild("Backpack", 5)
	if not backpack then return false end

	-- Check duplicates
	if optionalOwnedSet then
		if optionalOwnedSet[cleanID] then return false end
	else
		local currentSet = getOwnedSet(player)
		if currentSet[cleanID] then return false end
	end

	local bpTool = tool:Clone()
	tagIssued(bpTool, tool.Name) 
	bpTool.Parent = backpack

	local sg = player:FindFirstChild("StarterGear")
	if sg then
		local sgTool = tool:Clone()
		tagIssued(sgTool, tool.Name)
		sgTool.Parent = sg
	end
	return true
end

-- ============================================================================
-- ðŸ’¬ CHAT HANDLER
-- ============================================================================

Players.PlayerAdded:Connect(function(player)
	player.Chatted:Connect(function(message)
		if not (IS_STUDIO or ADMIN_USER_IDS[player.UserId]) then return end

		local lastCmd = AdminDebounces[player.UserId] or 0
		if (os.clock() - lastCmd) < CMD_DEBOUNCE then return end
		AdminDebounces[player.UserId] = os.clock()

		if message:sub(1,1) ~= "/" then return end

		local args = message:split(" ")
		local command = args[1]:lower()

		-- [[ /give ]]
		if command == "/give" then
			local selector = args[2]
			local itemName = table.concat(args, " ", 3)
			if not selector or itemName == "" then return end

			local targets = getTargets(player, selector)
			if #targets == 0 then return end

			if itemName:lower() == "all" or itemName:lower() == "everything" then
				local allTools = getAllTools()
				for _, t in pairs(targets) do
					local ownedSet = getOwnedSet(t)
					for _, tool in pairs(allTools) do
						local id = getCleanID(tool.Name)
						if not ownedSet[id] then
							giveItem(t, tool, id, ownedSet)
							ownedSet[id] = true
						end
					end
					print("âœ… [Admin] Given ALL to " .. t.Name)
				end
				return
			end

			local tool = findTool(itemName)
			if tool then
				local cleanID = getCleanID(tool.Name)
				for _, t in pairs(targets) do
					if giveItem(t, tool, cleanID) then
						print("âœ… [Admin] Given " .. tool.Name .. " to " .. t.Name)
					else
						warn("âš ï¸ " .. t.Name .. " already has " .. tool.Name)
					end
				end
			end

			-- [[ /fly & /unfly ]]
		elseif command == "/fly" then
			local targets = getTargets(player, args[2])
			for _, t in pairs(targets) do setFlight(t, true) end

		elseif command == "/unfly" then
			local targets = getTargets(player, args[2])
			for _, t in pairs(targets) do setFlight(t, false) end

			-- [[ /clear & /clearall - FIXED ]]
		elseif command == "/clear" or command == "/clearall" then
			local targets = getTargets(player, args[2])
			if TycoonAdminAPI then
				for _, t in pairs(targets) do
					-- âœ… THIS IS THE FIX:
					-- We tell the DataHandler "ForceWipe". 
					-- This clears the items AND sets the 'ExplicitClear' flag.
					TycoonAdminAPI:Invoke("ForceWipe", t)
					print("ðŸ—‘ï¸ SECURE CLEAR: " .. t.Name)
				end
			else
				warn("âŒ Cannot clear: API Missing")
			end
		end
	end)
end)
