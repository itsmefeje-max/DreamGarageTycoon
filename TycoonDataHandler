-- [[ SERVER SIDE: TycoonDataHandler (Final Merged Version) ]]
-- -- Indicating what the script is for: Handles saving/loading player data with UpdateAsync protection, Anti-Wipe, and Pending Earnings recovery.

local Players = game:GetService("Players")
local ServerStorage = game:GetService("ServerStorage")
local DataStoreService = game:GetService("DataStoreService")
local Workspace = game:GetService("Workspace")

-- ğŸ”’ DATABASE CONFIG
local DATA_KEY = "TycoonData_Economy_V3" 
local PlayerDataStore = DataStoreService:GetDataStore(DATA_KEY)

-- ğŸ“‚ STORAGE
local CarTools = ServerStorage:WaitForChild("CarTools") 
local TycoonFolder = Workspace:WaitForChild("Tycoons") -- CHECK NAME: Ensure your folder is named "Tycoons" or "TycoonFolder"
local STARTER_CAR_NAME = "Delta Item" -- Your specific starter item

-- ğŸ› ï¸ HELPER: Give items safely
local function giveTool(player, toolName)
	if not player or not player.Parent then return end

	-- Check both Backpack and StarterGear so we don't give duplicates
	if player.Backpack:FindFirstChild(toolName) or player.StarterGear:FindFirstChild(toolName) then return end

	local tool = CarTools:FindFirstChild(toolName)
	if tool then
		tool:Clone().Parent = player.Backpack
		tool:Clone().Parent = player.StarterGear
	end
end

-- ğŸ› ï¸ HELPER: Find Player Plot (New Safety Function)
-- This ensures we find the plot to save pending money, even if attributes fail.
local function findPlayerPlot(player)
	-- 1. Check Attribute (Fastest)
	local plotName = player:GetAttribute("OccupiedPlot")
	if plotName and TycoonFolder:FindFirstChild(plotName) then
		return TycoonFolder[plotName]
	end

	-- 2. Fallback: Search manually
	for _, plot in pairs(TycoonFolder:GetChildren()) do
		local ownerVal = plot:FindFirstChild("Owner") 
		if ownerVal and (ownerVal.Value == player or ownerVal.Value == player.Name) then
			return plot
		end
	end
	return nil
end

-- ğŸ“¥ JOIN LOGIC
Players.PlayerAdded:Connect(function(player)
	-- 1. Create Leaderstats
	local leaderstats = Instance.new("Folder"); leaderstats.Name = "leaderstats"; leaderstats.Parent = player
	local bank = Instance.new("IntValue"); bank.Name = "Cash"; bank.Parent = leaderstats
	local wallet = Instance.new("IntValue"); wallet.Name = "Wallet"; wallet.Value = 0; wallet.Parent = leaderstats

	local playerKey = "User_" .. player.UserId
	local savedData = nil

	-- 2. Try to Load Data (Protected Call)
	local success, errorMessage = pcall(function() 
		savedData = PlayerDataStore:GetAsync(playerKey) 
	end)

	if success then
		-- âœ… SAFETY LOCK ENGAGED
		player:SetAttribute("DataLoaded", true)

		if savedData then
			print("âœ… Loaded Data for " .. player.Name)
			bank.Value = savedData.Bank or 0
			wallet.Value = savedData.Wallet or 0

			-- Load Inventory
			if savedData.Inventory then
				for _, tName in pairs(savedData.Inventory) do 
					giveTool(player, tName) 
				end
			end
			
			-- RESTORE PENDING EARNINGS (The Fix)
			-- If they crashed with money in the collector, add it to wallet now.
			if savedData.PendingEarnings and savedData.PendingEarnings > 0 then
				wallet.Value = wallet.Value + savedData.PendingEarnings
				print("ğŸ’° Restored " .. savedData.PendingEarnings .. " pending cash to " .. player.Name)
			end
		else
			print("ğŸ†• New Player: " .. player.Name)
			bank.Value = 0
			wallet.Value = 0
			giveTool(player, STARTER_CAR_NAME) 
		end
	else
		-- ğŸ›‘ LOAD FAILED - KICK TO PREVENT DATA LOSS
		warn("âš ï¸ DATA LOAD ERROR for " .. player.Name .. ": " .. tostring(errorMessage))
		player:Kick("Data failed to load. Please rejoin to prevent data loss.")
	end
end)

-- ğŸ’¾ LEAVE LOGIC (UPDATED TO UpdateAsync + Pending Check)
local function savePlayerData(player)
	-- ğŸ›‘ CRITICAL CHECK: Did data load correctly?
	if not player:GetAttribute("DataLoaded") then
		warn("ğŸ›‘ ABORTING SAVE for " .. player.Name .. " (Data did not load correctly on join).")
		return 
	end

	local leaderstats = player:FindFirstChild("leaderstats")
	if not leaderstats then return end

	-- 1. Scan Inventory
	local inventoryTable = {}
	if player:FindFirstChild("StarterGear") then
		for _, tool in pairs(player.StarterGear:GetChildren()) do
			if CarTools:FindFirstChild(tool.Name) then 
				table.insert(inventoryTable, tool.Name) 
			end
		end
	end

	-- 2. CAPTURE PENDING EARNINGS (Crucial Fix)
	local currentPending = 0
	local plot = findPlayerPlot(player)
	
	if plot then
		local pendingVal = plot:FindFirstChild("PendingEarnings")
		if pendingVal then currentPending = pendingVal.Value end
	end

	-- 3. UPDATE ASYNC (The Safe Way)
	local playerKey = "User_" .. player.UserId
	
	local success, err = pcall(function()
		PlayerDataStore:UpdateAsync(playerKey, function(oldData)
			-- Return the new data table to overwrite
			local newData = {
				Bank = leaderstats.Cash.Value,
				Wallet = leaderstats.Wallet.Value,
				Inventory = inventoryTable,
				PendingEarnings = currentPending -- Save the money inside the collector
			}
			return newData
		end)
	end)

	if success then
		print("ğŸ’¾ Saved Data (UpdateAsync) for " .. player.Name)
	else
		warn("âš ï¸ CRITICAL: Data Save Failed for " .. player.Name .. ": " .. tostring(err))
	end
end

-- Connect Events
Players.PlayerRemoving:Connect(savePlayerData)

game:BindToClose(function() 
	for _, p in pairs(Players:GetPlayers()) do 
		task.spawn(function()
			savePlayerData(p) 
		end)
	end 
	task.wait(3) 
end)
